<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventario Global de Maquinas</title>
    <link rel="icon" type="image/png" href="/logo_wisi.png">
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <meta name="theme-color" content="#1a1a27">
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow: hidden; margin: 0; }
        #view-login { height: 100vh; display: flex; align-items: center; justify-content: center; background: #1a1a27; }
        .login-card { width: 360px; border-radius: 12px; border: none; }
        #view-app { display: none; height: 100vh; width: 100%; }
        
        /* --- ESTILOS DEL SIDEBAR COMPACTO --- */
        #sidebar { 
            width: 190px; /* Reducido de 230px a 190px */
            background: #1a1a27; 
            padding: 10px; /* Reducido de 15px */
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
        }

        #sidebar .brand { 
            color: white; 
            text-align: center; 
            font-weight: bold; 
            text-transform: uppercase; 
            border-bottom: 1px solid #2b2b40; 
            padding-bottom: 10px; /* Menos espacio abajo */
            margin-bottom: 10px; /* Menos margen */
            font-size: 0.8rem; /* Letra más pequeña (antes 0.9rem) */
            line-height: 1.2;
        }

        #sidebar a { 
            color: #92929f; 
            display: block; 
            padding: 6px 10px; /* Menos relleno (antes 10px) */
            text-decoration: none; 
            border-radius: 6px; 
            font-size: 0.75rem; /* Letra más pequeña (antes 0.85rem) */
            cursor: pointer; 
            margin-bottom: 2px; /* Un pelín de separación entre items */
        }

        #sidebar a:hover, .active-link { 
            background: #2b2b40; 
            color: #009ef7 !important; 
        }

        .sidebar-user-info { 
            padding: 8px; /* Más compacto */
            text-align: center; 
            border-top: 1px solid #2b2b40; 
            margin-top: auto; 
            background: #1e1e2d; 
            border-radius: 6px; 
            cursor: pointer; 
        }

        .user-name { 
            color: white; 
            font-size: 0.75rem; /* Reducido */
            font-weight: 600; 
            display: block; 
        }

        .user-level { 
            color: #009ef7; 
            font-size: 0.65rem; /* Reducido */
            text-transform: uppercase; 
            font-weight: 700; 
            display: block; 
            margin-bottom: 5px; 
        }

        .btn-logout { 
            color: #f1416c !important; 
            border: 1px solid #f1416c; 
            font-size: 0.7rem; 
            font-weight: bold; 
            padding: 2px 0; /* Botón más delgado */
        }

        #main { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .table { font-size: 0.76rem; vertical-align: middle; }
        .table thead th { background: #f1f1f4; text-transform: uppercase; font-size: 0.68rem; padding: 10px 5px; }
        .report-summary-row td, .table tfoot td { background: #e1e3ea !important; padding: 10px 15px; font-size: 0.75rem; border-top: 2px solid #ced4da; }
        .btn-action { padding: 3px 10px; font-size: 0.7rem; font-weight: 600; }
        .filter-label { font-size: 0.65rem; font-weight: bold; color: #5e6278; text-transform: uppercase; }
        .form-filter { font-size: 0.75rem; height: 32px; }
        .detail-card { border: 1px solid #ebedef; border-radius: 6px; background: white; margin-bottom: 10px; }
        .detail-card h6 { font-size: 0.7rem; font-weight: 800; background: #f4f4f7; padding: 10px; margin: 0; color: #009ef7; text-transform: uppercase; }
        .is-invalid { border-color: #dc3545 !important; background-image: none !important; }
        .feedback-error { color: #dc3545; font-size: 0.7rem; margin-top: 2px; font-weight: bold; display: none; }

        /* Transición suave para expandir/colapsar */
        /* Altura ajustada para mostrar aprox. 3 filas */
        .table-container-limit {
            max-height: 110px; /* Ajustado para ver solo 3 registros */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .table-container-full {
            max-height: 1000px; /* Altura suficiente para mostrar todo */
            overflow-y: auto;
        }

        .badge-counter {
            background-color: #eef2f5; 
            color: #1F4E78; 
            border: 1px solid #1F4E78;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.7rem;
        }

        /* Estilo para los filtros Multi-Select */
        .dropdown-check-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.75rem;
        }
        .dropdown-check-list .form-check {
            padding: 0.3rem 0.8rem;
            margin: 0;
            cursor: pointer;
        }
        .dropdown-check-list .form-check:hover {
            background-color: #f8f9fa;
        }
        .dropdown-toggle {
            font-size: 0.75rem;
            text-align: left;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-toggle::after {
            margin-left: auto;
        }

        /* Estilos para la etiqueta de impresión */
@media print {
    @page {
        size: 57mm 32mm;
        margin: 0;
    }
    body * { visibility: hidden; }
    #print-section, #print-section * { visibility: visible; }
    #print-section {
        position: absolute;
        left: 0; top: 0;
        width: 57mm;
        height: 32mm;
        padding: 2mm;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: white;
    }
}

.label-container {
    width: 57mm;
    height: 32mm;
    font-family: Arial, sans-serif;
    padding: 2mm;
    border: 1px dashed #ccc; /* Solo visible en pantalla */
    display: flex;
    flex-direction: column;
    line-height: 1.1;
}

.label-title { font-size: 10pt; font-weight: bold; border-bottom: 1px solid black; margin-bottom: 2px; text-align: center; }
.label-item { font-size: 7pt; margin-bottom: 1px; }
.label-footer { font-size: 6pt; margin-top: auto; text-align: right; font-style: italic; }

    </style>
</head>
<body>

<div id="view-login">
    <div class="card login-card p-4 text-center">
        <h4 class="fw-bold">BIENVENIDO</h4>
        <p class="text-muted small">Inventario Global de Maquinas</p>
        <form id="formLogin">
            <div class="text-start mb-3"><label class="filter-label">Usuario</label><input type="text" id="log-user" class="form-control" required></div>
            <div class="text-start mb-3"><label class="filter-label">Clave</label><input type="password" id="log-pass" class="form-control" required></div>
            <div id="loginError" class="alert alert-danger p-2 small mb-3" style="display:none;"></div>
            <button type="submit" class="btn btn-primary w-100 fw-bold">ENTRAR</button>
        </form>
    </div>
</div>

<div id="view-app">
    <nav id="sidebar">
        <div class="brand">Inventario Global<br>de Maquinas</div>
        <a onclick="cambiarVista('maquina')" id="link-maquina">Máquinas</a>
        <a onclick="cambiarVista('pianas')" id="link-pianas">Pianas</a>
        <div id="menu-admin-only">
            <hr style="border-color: #2b2b40;">
            <a onclick="cambiarVista('grupo')" id="link-grupo">Grupos</a>
            <a onclick="cambiarVista('sucursal')" id="link-sucursal">Sucursales</a>
            <a onclick="cambiarVista('estado')" id="link-estado">Estados</a>
            <a onclick="cambiarVista('sociedad')" id="link-sociedad">Sociedades</a>
            <a onclick="cambiarVista('valor')" id="link-valor">Valores</a>
            <a onclick="cambiarVista('juego')" id="link-juego">Juegos</a>
            <a onclick="cambiarVista('marca')" id="link-marca">Marcas</a>
            <a onclick="cambiarVista('modelo')" id="link-modelo">Modelos</a>
            <a onclick="cambiarVista('tipo')" id="link-tipo">Tipos</a>
            <a onclick="cambiarVista('modo')" id="link-modo">Modos</a>
            <a onclick="cambiarVista('legal')" id="link-legal">Legal</a>
        </div>
        <div class="sidebar-user-info" onclick="irAVistaUsuarios()">
            <span class="user-name" id="display-user-name">---</span>
            <span class="user-level" id="display-user-level">---</span>
            <a onclick="event.stopPropagation(); cerrarSesion();" class="btn btn-logout w-100 mt-2">Cerrar Sesión</a>
        </div>
    </nav>

    <main id="main">
        <div id="section-lista">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="viewTitle" class="fw-bold m-0 text-dark">Máquinas</h5>
                <button class="btn btn-success btn-action px-4" id="btn-nuevo-global" onclick="controladorAccionNuevo()">Nuevo Registro</button>
            </div>
            <div class="card mb-3" id="panelFiltros" style="display:none;">
                <div class="card-body p-3">
                    <div class="row g-2 mb-2">
                        <div class="col-md-3"><label class="filter-label">Nombre</label><input type="text" id="f-nombre" class="form-control form-filter shadow-none" placeholder="Buscar..."></div>
                        <div class="col-md-3"><label class="filter-label">Serial</label><input type="text" id="f-serial" class="form-control form-filter shadow-none" placeholder="Buscar..."></div>
                        <div class="col-md-3" id="container-f-sociedad"></div> <div class="col-md-3" id="container-f-legal"></div>    </div>
                    
                    <div class="row g-2 mb-2">
                        <div class="col-md-4" id="container-f-marca"></div>
                        <div class="col-md-4" id="container-f-modelo"></div>
                        <div class="col-md-4" id="container-f-juego"></div>
                    </div>
            
                    <div class="row g-2">
                        <div class="col-md-2" id="container-f-grupo"></div>
                        <div class="col-md-2" id="container-f-sucursal"></div>
                        <div class="col-md-2" id="container-f-estado"></div>
                        <div class="col-md-2" id="container-f-valor"></div>
                        <div class="col-md-2" id="container-f-tipo"></div>
                        <div class="col-md-2" id="container-f-modo"></div>
                    </div>
            
                    <div class="row g-2 mt-2">
                        <div class="col-md-4 mt-3"><button class="btn btn-secondary btn-action w-100" onclick="resetFiltros()">Limpiar Filtros</button></div>
                        <div class="col-md-4 mt-3"><button class="btn btn-warning btn-action w-100 fw-bold" onclick="exportarExcel()">Excel</button></div>
                        <div class="col-md-4 mt-3"><button class="btn btn-danger btn-action w-100 fw-bold" onclick="exportarPDF()"><i class="bi bi-file-pdf"></i> PDF</button></div>
                    </div>
                </div>
            </div>
            <div class="card shadow-sm"><div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead id="tHead">
                        <tr id="tHeadCountTypes" class="bg-white" style="display:none;">
                            <td colspan="16" class="p-2 border-0"></td>
                        </tr>
                        <tr id="tHeadSummary" class="report-summary-row" style="display:none;">
                            <td colspan="16"></td>
                        </tr>
                        <tr id="tHeadTitles" class="table-light"></tr></thead>
                    <tbody id="tBody"></tbody><tfoot id="tFoot"></tfoot>
                </table>
            </div></div>
        </div>
        <div id="section-detalles" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Análisis Detallado</h5><button class="btn btn-dark btn-sm" onclick="cerrarVistaDetalles()">Volver</button></div>
            <div class="alert alert-primary py-2 x-small mb-3 shadow-sm" id="alertFiltrosDetalles"></div>
            <div class="row g-3" id="containerTablasDetalles"></div>
        </div>
        <div id="section-formulario" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Gestión</h5><button class="btn btn-sm btn-outline-secondary" onclick="cancelarFormulario()">Volver</button></div>
            <div class="card"><div class="card-body"><form id="formMaquinaFull"><div class="row" id="camposMaquina"></div><hr><div class="text-end"><button type="submit" id="btnGuardarMaquina" class="btn btn-primary px-5">Guardar</button></div></form></div></div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalParam" data-bs-backdrop="static"><div class="modal-dialog"><form id="formParam" class="modal-content"><div class="modal-header border-0"><h6>Nuevo Registro</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modalFields"></div><div class="modal-footer border-0"><button type="submit" id="btnGuardarParam" class="btn btn-primary w-100">Guardar</button></div></form></div></div>

<div class="modal fade" id="modalSucursales" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header border-0"><h6>Asignar Sucursales</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-muted">Marque las sucursales permitidas para este usuario:</p><div id="containerSucursales" style="max-height: 350px; overflow-y: auto;"></div></div><div class="modal-footer border-0"><button onclick="guardarSucursales()" class="btn btn-primary w-100 fw-bold">Guardar Permisos</button></div></div></div></div>

<div class="modal fade" id="modalConfirmarEliminar" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">Confirmar</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-muted mb-0">¿Estás seguro de eliminar este registro?</p></div><div class="modal-footer border-0 justify-content-center"><button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger btn-sm px-4" id="btnConfirmarAccion">Sí, Eliminar</button></div></div></div></div>

<div class="modal fade" id="modalErrorRelacion" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0 text-danger"><h6 class="modal-title fw-bold">Acción Denegada</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-muted mb-0" id="msgErrorRelacion"></p></div><div class="modal-footer border-0"><button type="button" class="btn btn-dark btn-sm w-100" data-bs-dismiss="modal">Entendido</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "/api"; 
    let vista = "maquina", allData = [], editId = null, currentFiltered = [], usuarioActual = null, refreshInt = null;
    let targetDelete = { id: null, tabla: null };
    let tempUserId = null; 
    let expandedCards = new Set(); // Guardará los IDs de las tarjetas abiertas
    // Agrega estas variables al inicio con las otras
    let currentPage = 1;
    let itemsPerPage = 10; // Ahora es variable (let) y empieza en 10

    const modalParam = new bootstrap.Modal(document.getElementById('modalParam'));
    const modalConfirm = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
    const modalError = new bootstrap.Modal(document.getElementById('modalErrorRelacion'));
    const modalSucursales = new bootstrap.Modal(document.getElementById('modalSucursales'));
    
    // --- ESTADO DE LOS FILTROS (MEMORIA) ---
    // Aquí guardamos qué casillas están marcadas para no perderlas al refrescar
    let estadoFiltros = {
        grupo: [], sucursal: [], marca: [], modelo: [], juego: [],
        estado: [], sociedad: [], valor: [], tipo: [], modo: [], legal: []
    };

    // Configuración de campos y sus contenedores
    const configFiltros = [
        { id: 'grupo', key: 'grupo_nom', label: 'Grupo' },
        { id: 'sucursal', key: 'sala_nom', label: 'Sala' },
        { id: 'marca', key: 'marca_nom', label: 'Marca' },
        { id: 'modelo', key: 'modelo_nom', label: 'Modelo' },
        { id: 'juego', key: 'juego_nom', label: 'Juego' },
        { id: 'estado', key: 'estado_nom', label: 'Estado' },
        { id: 'sociedad', key: 'sociedad_nom', label: 'Sociedad' },
        { id: 'valor', key: 'valor_nom', label: 'Valor' },
        { id: 'tipo', key: 'tipo_nom', label: 'Tipo' },
        { id: 'modo', key: 'modo_nom', label: 'Modo' },
        { id: 'legal', key: 'legal_nom', label: 'Legal' }
    ];

    // Función Helper: Obtiene la data filtrada ignorando UN filtro específico.
    // Esto sirve para llenar las opciones del dropdown "Marca", considerando lo que elegiste en "Grupo",
    // pero ignorando lo que elegiste en "Marca" (para que sigas viendo las otras marcas disponibles).
    function obtenerOpcionesDisponibles(filtroIgnorado) {
        const fNombre = (document.getElementById('f-nombre')?.value || "").toLowerCase();
        const fSerial = (document.getElementById('f-serial')?.value || "").toLowerCase();

        return allData.filter(m => {
            // 1. Filtros de Texto (Siempre aplican)
            if (! (m.nombre || "").toLowerCase().includes(fNombre)) return false;
            if (! (m.serial || "").toLowerCase().includes(fSerial)) return false;

            // 2. Filtros de Selects (Ignorando el actual)
            for (const conf of configFiltros) {
                if (conf.id === filtroIgnorado) continue; // SALTAMOS el filtro que estamos renderizando
                
                const seleccionados = estadoFiltros[conf.id];
                const valorMaquina = m[conf.key] || "N/A";
                
                if (seleccionados.length > 0 && !seleccionados.includes(valorMaquina)) {
                    return false;
                }
            }
            return true;
        });
    }

    // filtroActivo: Es el ID del filtro que el usuario está tocando en este momento.
    // Si pasamos este parámetro, NO redibujamos ese filtro para evitar que el menú se cierre.
    function renderizarFiltrosMultiselect(filtroActivo = null) {
        configFiltros.forEach(conf => {
            // Si el usuario está interactuando con este filtro, NO lo tocamos visualmente
            // para no interrumpir su acción.
            if (conf.id === filtroActivo) {
                actualizarTextoBoton(conf.id); 
                return; 
            }

            const container = document.getElementById(`container-f-${conf.id}`);
            if (!container) return;

            // 1. Obtenemos la data disponible basada en TODOS los otros filtros
            // Esto ya nos trae el universo de datos "posibles" para este dropdown
            const dataContexto = obtenerOpcionesDisponibles(conf.id);
            
            // --- NUEVO: LÓGICA DE CONTEO ---
            const conteo = {};
            dataContexto.forEach(m => {
                const val = m[conf.key] || "N/A";
                conteo[val] = (conteo[val] || 0) + 1;
            });
            // -------------------------------

            // 2. Sacamos los valores únicos (Las llaves del objeto conteo) y ordenamos
            let uniqueValues = Object.keys(conteo).sort();

            // 3. Renderizamos HTML
            const seleccionados = estadoFiltros[conf.id] || [];
            
            // Lógica del botón (Texto)
            let labelBtn = 'TODOS';
            let btnClass = 'btn-outline-secondary';
            
            if (seleccionados.length > 0) {
                // Verificamos si los seleccionados siguen siendo válidos en el contexto actual
                const validos = seleccionados.filter(s => uniqueValues.includes(s));
                
                if (validos.length > 0) {
                    labelBtn = validos.length === uniqueValues.length ? 'TODOS' : `(${validos.length}) Selec.`;
                    btnClass = 'btn-primary';
                }
            }

            let html = `
                <label class="filter-label">${conf.label}</label>
                <div class="dropdown">
                    <button class="btn ${btnClass} dropdown-toggle w-100" type="button" 
                            id="btn_drop_${conf.id}" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                        ${labelBtn}
                    </button>
                    <div class="dropdown-menu w-100 p-0 shadow">
                        <div class="p-2 border-bottom bg-light d-flex justify-content-between">
                            <span class="small fw-bold text-muted">Opciones (${uniqueValues.length})</span>
                            <a href="#" onclick="limpiarUnFiltro('${conf.id}')" class="small text-decoration-none">Limpiar</a>
                        </div>
                        <div class="dropdown-check-list p-2">
            `;

            if (uniqueValues.length === 0) {
                html += `<div class="text-muted small text-center p-2">Sin opciones</div>`;
            } else {
                uniqueValues.forEach(val => {
                    const isChecked = seleccionados.includes(val) ? 'checked' : '';
                    const cantidad = conteo[val]; // Recuperamos el número calculado
                    
                    // --- DISEÑO DEL ITEM CON CONTADOR ---
                    // Usamos d-flex para separar el Nombre a la izquierda y el Número a la derecha
                    html += `
                        <div class="form-check d-flex justify-content-between align-items-center pe-2">
                            <div style="flex-grow: 1;">
                                <input class="form-check-input filter-chk" type="checkbox" 
                                    data-filter-type="${conf.id}" value="${val}" id="chk_${conf.id}_${val.replace(/\s+/g, '')}" ${isChecked}
                                    onchange="actualizarEstadoFiltro('${conf.id}', this.value, this.checked)">
                                <label class="form-check-label w-100 text-truncate" for="chk_${conf.id}_${val.replace(/\s+/g, '')}" style="cursor:pointer; font-size: 0.75rem;">
                                    ${val}
                                </label>
                            </div>
                            <span class="badge bg-light text-secondary border rounded-pill ms-2" style="font-size: 0.65rem;">
                                ${cantidad}
                            </span>
                        </div>
                    `;
                });
            }

            html += `   </div>
                    </div>
                </div>`;

            container.innerHTML = html;
        });
    }

    // Función auxiliar solo para actualizar el texto del botón del filtro activo sin cerrar el menú
    function actualizarTextoBoton(id) {
        const btn = document.getElementById(`btn_drop_${id}`);
        if(!btn) return;
        const seleccionados = estadoFiltros[id];
        const totalPosibles = document.querySelectorAll(`#container-f-${id} .filter-chk`).length; // Aproximación
        
        if (seleccionados.length > 0) {
            btn.innerText = `(${seleccionados.length}) Selec.`;
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-primary');
        } else {
            btn.innerText = 'TODOS';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-secondary');
        }
    }

    // Función que se llama cada vez que haces clic en un checkbox
    function actualizarEstadoFiltro(tipo, valor, marcado) {
        if (marcado) {
            if (!estadoFiltros[tipo].includes(valor)) {
                estadoFiltros[tipo].push(valor);
            }
        } else {
            estadoFiltros[tipo] = estadoFiltros[tipo].filter(v => v !== valor);
        }
        
        // 1. Aplicamos el filtro a la tabla inmediatamente
        aplicarFiltros(); 

        // 2. IMPORTANTE: Regeneramos LOS OTROS dropdowns para que reaccionen a este cambio.
        // Pasamos 'tipo' para decirle: "No recargues este filtro, que lo tengo abierto".
        renderizarFiltrosMultiselect(tipo);
    }

    function limpiarUnFiltro(tipo) {
        estadoFiltros[tipo] = [];
        aplicarFiltros();
        renderizarFiltrosMultiselect(null); // Aquí sí regeneramos todo porque el click cerró el menú
    }

    function aplicarPermisosUI() {
        if(!usuarioActual) return;
        document.getElementById('menu-admin-only').style.display = (usuarioActual.nivel == 1) ? 'block' : 'none';
        document.getElementById('btn-nuevo-global').style.display = (usuarioActual.nivel == 3) ? 'none' : 'block';
    }

    function verificarSesion() {
        const stored = localStorage.getItem('usuarioInventario');
        if (stored) {
            usuarioActual = JSON.parse(stored);
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-app').style.display = 'flex';
            actualizarInterfazPerfil();

            // --- CAMBIO AQUÍ: RESTAURAR VISTA SOLO SI HAY SESIÓN ---
            const vistaGuardada = localStorage.getItem('ultimaVista') || 'maquina';
            cambiarVista(vistaGuardada);
            // -------------------------------------------------------

        } else {
            detenerRealTime();
            document.getElementById('view-login').style.display = 'flex';
            document.getElementById('view-app').style.display = 'none';
        }
    }

    function actualizarInterfazPerfil() {
        const lvls = {1:'Administrador', 2:'Supervisor', 3:'Normal'};
        document.getElementById('display-user-name').innerText = usuarioActual.nombre;
        document.getElementById('display-user-level').innerText = lvls[usuarioActual.nivel] || 'Usuario';
    }

    function irAVistaUsuarios() { if(usuarioActual.nivel == 1) cambiarVista('usuario'); }

    function iniciarRealTime() {
        if(refreshInt) clearInterval(refreshInt);
        refreshInt = setInterval(async () => {
            if(!document.querySelector('.modal.show') && document.getElementById('section-formulario').style.display === 'none') {
                await cargarTabla();
                sincronizarUsuarioLogueado();
                if(document.getElementById('section-detalles').style.display === 'block') abrirVistaDetalles(true);
            }
        }, 5000);
    }

    async function sincronizarUsuarioLogueado() {
        try {
            const res = await fetch(`${API}/usuario/${usuarioActual.id}`);
            const data = await res.json();
            if(data.id) { usuarioActual = data; localStorage.setItem('usuarioInventario', JSON.stringify(data)); actualizarInterfazPerfil(); }
        } catch(e) {}
    }

    function detenerRealTime() { if(refreshInt) clearInterval(refreshInt); }

    async function cargarTabla() {
        if (!usuarioActual) return;
        
        // 1. MOSTRAR SPINNER DE CARGA
        const body = document.getElementById('tBody');
        const cols = (vista === 'maquina') ? 16 : 5; // Ajuste columnas según vista
        body.innerHTML = `
            <tr>
                <td colspan="${cols}" class="text-center p-5">
                    <div class="spinner-border text-primary mb-2" role="status"></div>
                    <h6 class="text-muted fw-bold">Cargando datos...</h6>
                </td>
            </tr>`;

        // 2. PEDIR DATOS
        try {
            const res = await fetch(`${API}/${vista}?userId=${usuarioActual.id}`);
            const data = await res.json();
            allData = Array.isArray(data) ? data : [];
            
            if (vista === 'maquina') {
                // Renderizado inicial limpio
                renderizarFiltrosMultiselect(); 
                aplicarFiltros(); 
            } else {
                renderizarTabla(allData);
            }
        } catch (error) {
            body.innerHTML = `<tr><td colspan="${cols}" class="text-center text-danger p-4">Error al cargar datos. Verifique su conexión.</td></tr>`;
        }
    }

    function aplicarFiltros() {
        // Si cambian los inputs de texto, también queremos que los dropdowns se actualicen
        // para mostrar solo opciones compatibles con ese texto.
        const activeElement = document.activeElement;
        const isTyping = (activeElement.id === 'f-nombre' || activeElement.id === 'f-serial');

        // Si estoy escribiendo, NO quiero redibujar los filtros a cada letra porque es lento visualmente,
        // pero si quiero filtrar la tabla.
        // Opcional: Si quieres que los dropdowns se filtren mientras escribes, llama a renderizarFiltrosMultiselect(null) aquí.
        if(isTyping) {
            renderizarFiltrosMultiselect(); 
        }

        if (vista !== 'maquina') return;

        // RESETEAR PÁGINA (ESTO ES CLAVE)
        currentPage = 1;
        
        // Usamos la misma lógica "Global" para la tabla
        // Filtramos la data considerando TODOS los filtros activos
        const fNombre = (document.getElementById('f-nombre')?.value || "").toLowerCase();
        const fSerial = (document.getElementById('f-serial')?.value || "").toLowerCase();

        currentFiltered = allData.filter(m => {
            if (! (m.nombre || "").toLowerCase().includes(fNombre)) return false;
            if (! (m.serial || "").toLowerCase().includes(fSerial)) return false;

            for (const conf of configFiltros) {
                const seleccionados = estadoFiltros[conf.id];
                const valorMaquina = m[conf.key] || "N/A";
                if (seleccionados.length > 0 && !seleccionados.includes(valorMaquina)) {
                    return false;
                }
            }
            return true;
        });

        renderizarTabla(currentFiltered);
        
        const totalFiltrosActivos = Object.values(estadoFiltros).reduce((acc, arr) => acc + arr.length, 0) 
                                + (fNombre ? 1 : 0) + (fSerial ? 1 : 0);
        // CAMBIO AQUÍ: Solo pasamos la cantidad, la función nueva lee los filtros globales
        generarResumenReporte(currentFiltered.length);
    }

    function renderizarTabla(data) {
        const titles = document.getElementById('tHeadTitles'), body = document.getElementById('tBody');

        // --- VALIDACIÓN: SI NO HAY DATOS ---
        if (data.length === 0) {
            const cols = (vista === 'maquina') ? 16 : 5;
            body.innerHTML = `
                <tr>
                    <td colspan="${cols}" class="text-center p-4 bg-light text-muted">
                        <i class="bi bi-inbox fs-4 d-block mb-1"></i>
                        Sin registros encontrados
                    </td>
                </tr>`;
            if(vista === 'maquina') generarResumenReporte(0);
            return;
        }

        // --- LÓGICA VISTA MÁQUINAS (PAGINACIÓN) ---
        if(vista === 'maquina') {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>Serial</th><th>Grupo</th><th>Sala</th><th>Marca</th><th>Modelo</th><th>Juego</th><th>Estado</th><th>Soc.</th><th>Val.</th><th>Tipo</th><th>Puestos</th><th>Modo</th><th>Legal</th><th class="text-center">Acciones</th>`;
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = (itemsPerPage > 10000) ? data.length : start + itemsPerPage; // Manejo de "Todas"
            const pageData = data.slice(start, end);

            body.innerHTML = pageData.map(i => {
                const badgeColor = (i.serial === 'N/A' || !i.serial) ? 'bg-danger' : 'bg-dark';

                // Determinamos si mostramos Editar/Borrar según el nivel
                const isAdminOrSuper = (usuarioActual.nivel == 1 || usuarioActual.nivel == 2);
                const styleAdminOnly = isAdminOrSuper ? '' : 'display:none';

                return `
                    <tr>
                        <td>${i.id}</td>
                        <td><b>${i.nombre}</b></td>
                        <td><span class="badge ${badgeColor}">${i.serial || 'N/A'}</span></td>
                        <td>${i.grupo_nom || '-'}</td>
                        <td>${i.sala_nom || '-'}</td>
                        <td>${i.marca_nom || '-'}</td>
                        <td>${i.modelo_nom || '-'}</td>
                        <td>${i.juego_nom || '-'}</td>
                        <td>${i.estado_nom || '-'}</td>
                        <td>${i.sociedad_nom || '-'}</td>
                        <td>${i.valor_nom || '-'}</td>
                        <td>${i.tipo_nom || '-'}</td>
                        <td class="fw-bold text-center">${i.puestos || '1'}</td>
                        <td>${i.modo_nom || '-'}</td>
                        <td>${i.legal_nom || '-'}</td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">
                                <button onclick="abrirEditorMaquina(${i.id})" class="btn btn-outline-primary btn-action" style="${styleAdminOnly}">Editar</button> 
                                <button onclick="solicitarEliminar(${i.id}, 'maquina')" class="btn btn-outline-danger btn-action" style="${styleAdminOnly}">Borrar</button>
                                <button onclick="imprimirEtiqueta(${i.id})" class="btn btn-outline-dark btn-action" title="Imprimir Etiqueta 57x32">57x32</button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');

        // --- OTRAS VISTAS ---
        } else if (vista === 'pianas') {
            // VISTA ESPECÍFICA DE PIANAS
            titles.innerHTML = `<th>ID</th>
                                <th>Sucursal / Sala</th>
                                <th>Grupo</th>
                                <th class="text-center">Cant. Pianas</th>
                                <th class="text-center">Pianas Grandes (1x3)</th>
                                <th class="text-center">Acciones</th>`;
            
            body.innerHTML = data.map(i => `
                <tr>
                    <td>${i.id}</td>
                    <td><b>${i.nombre}</b></td>
                    <td>${i.grupo_nom || '-'}</td>
                    <td class="text-center">
                        <span class="badge bg-primary fs-6">${i.pianas || 0}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info text-dark fs-6">${i.pianas_xl || 0}</span>
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center">
                            <button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">
                                <i class="bi bi-pencil"></i> Editar
                            </button> 
                            </div>
                    </td>
                </tr>`).join('');

        } else if (vista === 'sucursal' || vista === 'modelo') {
            const padre = (vista === 'sucursal') ? 'Grupo' : 'Marca';
            const nomPadre = (vista === 'sucursal') ? 'grupo_nom' : 'marca_nom';
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>${padre}</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => `
                <tr>
                    <td>${i.id}</td>
                    <td>${i.nombre}</td>
                    <td><span class="badge bg-light text-dark border">${i[nomPadre] || '-'}</span></td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                            <button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> 
                            <button onclick="solicitarEliminar(${i.id}, '${vista}')" class="btn btn-outline-danger btn-action">Borrar</button>
                        </div>
                    </td>
                </tr>`).join('');
        
        } else if (vista === 'usuario') {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>Usuario</th><th>Nivel</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => { 
                const l = {1:'Admin', 2:'Supervisor', 3:'Normal'}; 
                return `<tr>
                    <td>${i.id}</td><td>${i.nombre}</td><td>${i.usuario}</td>
                    <td><span class="badge bg-info text-dark">${l[i.nivel]}</span></td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                            <button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button>
                            <button onclick="abrirModalSucursales(${i.id})" class="btn btn-outline-warning btn-action">Sucursales</button>
                            ${(i.usuario === 'willinthon') ? 
                                '<button class="btn btn-outline-secondary btn-action" disabled>Lock</button>' : 
                                `<button onclick="solicitarEliminar(${i.id}, 'usuario')" class="btn btn-outline-danger btn-action">Borrar</button>`}
                        </div>
                    </td>
                </tr>`; 
            }).join('');
        
        } else {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => `
                <tr>
                    <td>${i.id}</td>
                    <td>${i.nombre}</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                            <button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> 
                            <button onclick="solicitarEliminar(${i.id}, '${vista}')" class="btn btn-outline-danger btn-action">Borrar</button>
                        </div>
                    </td>
                </tr>`).join('');
        }
    }

    function activarValidacionEnInput(selectorInput, tabla, campo, btnGuardarId, idRegistro = null) {
        const input = document.querySelector(selectorInput);
        if (!input) return;
        if(input.parentNode.querySelector('.feedback-error')){ input.parentNode.querySelector('.feedback-error').remove(); }
        let errorMsg = document.createElement('div');
        errorMsg.className = 'feedback-error';
        errorMsg.innerText = `Este ${campo} ya existe en la base de datos.`;
        input.parentNode.appendChild(errorMsg);
        const btn = document.getElementById(btnGuardarId);
        input.classList.remove('is-invalid');
        errorMsg.style.display = 'none';
        if(btn) btn.disabled = false;
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        const activeInput = document.querySelector(selectorInput);
        if(!activeInput.parentNode.querySelector('.feedback-error')) { activeInput.parentNode.appendChild(errorMsg); }
        activeInput.addEventListener('keyup', async () => {
            const valor = activeInput.value.trim();

            // NUEVA EXCEPCIÓN PARA "N/A"
            if (campo === 'serial' && (valor === "" || valor.toUpperCase() === 'N/A')) {
                activeInput.classList.remove('is-invalid');
                errorMsg.style.display = 'none';
                if(btn) btn.disabled = false;
                return; // Detiene la validación aquí para que no consulte a la API
            }

            if (valor.length < 2) {
                 activeInput.classList.remove('is-invalid');
                 errorMsg.style.display = 'none';
                 if(btn) btn.disabled = false;
                 return; 
            }
            try {
                let url = `${API}/validar/${tabla}/${campo}/${valor}`;
                if(idRegistro) { url += `?excludeId=${idRegistro}`; }
                const res = await fetch(url);
                const data = await res.json();
                if (data.existe) {
                    activeInput.classList.add('is-invalid');
                    errorMsg.style.display = 'block';
                    if(btn) btn.disabled = true;
                } else {
                    activeInput.classList.remove('is-invalid');
                    errorMsg.style.display = 'none';
                    if(btn) btn.disabled = false;
                }
            } catch (e) { console.error(e); }
        });
    }

    async function abrirModalSucursales(userId) {
        tempUserId = userId;
        const container = document.getElementById('containerSucursales');
        container.innerHTML = `<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><span class="ms-2 small text-muted">Cargando lista completa...</span></div>`;
        modalSucursales.show();
        try {
            // CORRECCIÓN DEFINITIVA: Llamado sin userId para traer la lista completa
            const resAll = await fetch(`${API}/options/sucursal`);
            const resPerm = await fetch(`${API}/permisos_sucursal/${userId}`);
            
            if (!resAll.ok || !resPerm.ok) throw new Error("Error al obtener datos");
            const allSuc = await resAll.json();
            const userPerms = await resPerm.json();
            
            if(allSuc.length === 0){ container.innerHTML = '<p class="text-muted text-center small p-3">No hay sucursales registradas.</p>'; return; }
            
            let html = '';
            allSuc.forEach(s => {
                const isChecked = userPerms.includes(s.id) ? 'checked' : '';
                const grupoLabel = s.parent_nom ? `<span class="badge bg-secondary" style="font-size:0.6rem">${s.parent_nom}</span> ` : '';
                html += `
                    <div class="form-check border-bottom py-2 m-0">
                        <input class="form-check-input chk-sucursal" type="checkbox" value="${s.id}" id="chk_${s.id}" ${isChecked}>
                        <label class="form-check-label small w-100" for="chk_${s.id}" style="cursor:pointer">
                            ${grupoLabel} <b>${s.nombre}</b>
                        </label>
                    </div>`;
            });
            container.innerHTML = html;
        } catch(e) { container.innerHTML = '<p class="text-danger small text-center p-3">Error de conexión al cargar sucursales.</p>'; }
    }

    async function guardarSucursales() {
        const btn = document.querySelector('#modalSucursales .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "Guardando...";
        btn.disabled = true;
        try {
            const checkedBoxes = document.querySelectorAll('.chk-sucursal:checked');
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            const res = await fetch(`${API}/asignar_sucursales`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usuario_id: tempUserId, sucursales: selectedIds })
            });
            if(res.ok) { modalSucursales.hide(); } else { alert("Error al guardar."); }
        } catch(e) { alert("Error de conexión."); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

    function actualizarDropdownsDinamicos(data) {
        const conf = {'f-grupo':'grupo_nom','f-sucursal':'sala_nom','f-marca':'marca_nom','f-modelo':'modelo_nom','f-juego':'juego_nom','f-estado':'estado_nom','f-sociedad':'sociedad_nom','f-valor':'valor_nom','f-tipo':'tipo_nom','f-modo':'modo_nom','f-legal':'legal_nom'};
        Object.keys(conf).forEach(id => { 
            const s = document.getElementById(id); 
            if(!s || document.activeElement === s) return; 
            const v = s.value; 
            const u = [...new Set(data.map(i => i[conf[id]]))].filter(x => x).sort(); 
            s.innerHTML = '<option value="">TODOS</option>' + u.map(x => `<option value="${x}" ${x==v?'selected':''}>${x}</option>`).join(''); 
        });
    }

    function generarResumenReporte(totalRegistros) {
        if (vista !== 'maquina') return;

        // --- 1. PREPARAR TEXTO DE FILTROS ---
        let descripciones = [];
        let contadorCategorias = 0;
        const fNombre = document.getElementById('f-nombre')?.value || "";
        const fSerial = document.getElementById('f-serial')?.value || "";

        if (fNombre) { descripciones.push(`Nombre: [ "${fNombre}" ]`); contadorCategorias++; }
        if (fSerial) { descripciones.push(`Serial: [ "${fSerial}" ]`); contadorCategorias++; }

        configFiltros.forEach(conf => {
            const seleccionados = estadoFiltros[conf.id];
            if (seleccionados && seleccionados.length > 0) {
                contadorCategorias++;
                descripciones.push(`<b>${conf.label}</b>: [ ${seleccionados.join(', ')} ]`);
            }
        });

        let textoDetalle = descripciones.length > 0 ? descripciones.join(', ') : "Ninguno";

        // --- 2. CÁLCULO DE CONTEO POR TIPOS (BADGES) ---
        const conteoTipos = {};
        currentFiltered.forEach(m => {
            const tipo = m.tipo_nom || "N/A";
            conteoTipos[tipo] = (conteoTipos[tipo] || 0) + 1;
        });

        const htmlBadges = Object.entries(conteoTipos).map(([nombre, cant]) => `
            <span class="badge border text-dark me-2 shadow-sm" style="background: #f8f9fa; font-size: 0.7rem; border-color: #dee2e6 !important;">
                <span class="text-primary fw-bold">${nombre.toUpperCase()}:</span> ${cant}
            </span>
        `).join('');

        const contenedorBadges = `
            <div class="d-flex flex-wrap gap-1 align-items-center">
                <small class="text-muted fw-bold me-2" style="font-size: 0.6rem; letter-spacing: 0.5px;">DISTRIBUCIÓN:</small>
                ${htmlBadges || '<small class="text-muted">Sin datos</small>'}
            </div>
        `;

        // --- 3. CÁLCULOS DE PAGINACIÓN ---
        const totalPages = Math.ceil(totalRegistros / itemsPerPage) || 1; 
        const disablePrev = currentPage === 1 ? 'disabled' : '';
        const disableNext = (currentPage >= totalPages || totalRegistros === 0) ? 'disabled' : '';
        const startShow = totalRegistros === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
        const endShow = Math.min(currentPage * itemsPerPage, totalRegistros);

        // --- 4. HTML DEL RESUMEN Y PAGINADO ---
        const htmlResumenPaginado = `
            <div class="d-flex align-items-center justify-content-between w-100 py-1" style="font-size: 0.75rem;">
                <div class="d-flex align-items-center" style="flex: 1; overflow: hidden; white-space: nowrap;">
                    <button class="btn btn-dark btn-sm shadow-sm me-3 flex-shrink-0" onclick="abrirVistaDetalles()">Detalles</button>
                    <div class="text-truncate">
                        <span class="me-2">Total: (<b>${totalRegistros}</b>)</span>
                        <span class="me-2 text-muted">|</span>
                        <span class="me-2">Filtros Totales: (<b>${contadorCategorias}</b>)</span>
                        <span class="text-muted">Filtros: ${textoDetalle}</span>
                    </div>
                </div>
                <div class="d-flex align-items-center flex-shrink-0 ms-3 gap-2">
                    <select class="form-select form-select-sm py-0 shadow-sm text-muted fw-bold bg-light" style="width:auto; font-size:0.75rem;" onchange="cambiarItemsPorPagina(this.value)">
                        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10 filas</option>
                        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50 filas</option>
                        <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100 filas</option>
                        <option value="999999" ${itemsPerPage > 100 ? 'selected' : ''}>Todas</option>
                    </select>
                    <span class="fw-bold text-dark mx-1">${startShow} - ${endShow} de ${totalRegistros}</span>
                    <div class="btn-group shadow-sm">
                        <button class="btn btn-outline-secondary btn-sm py-0 px-2 fw-bold" ${disablePrev} onclick="cambiarPagina(-1)">&lt;</button>
                        <button class="btn btn-secondary btn-sm py-0 px-2" disabled style="font-weight:bold;">${currentPage} / ${totalPages}</button>
                        <button class="btn btn-outline-secondary btn-sm py-0 px-2 fw-bold" ${disableNext} onclick="cambiarPagina(1)">&gt;</button>
                    </div>
                </div>
            </div>
        `;

        // --- 5. INYECCIÓN EN DOM ---
        
        // Inyectar Badges en el Header Superior (NUEVO)
        const rowCountHeader = document.getElementById('tHeadCountTypes');
        if (rowCountHeader) {
            rowCountHeader.style.display = 'table-row';
            rowCountHeader.cells[0].innerHTML = contenedorBadges;
        }

        // Inyectar Resumen en el Header Medio
        const tHeadSummary = document.getElementById('tHeadSummary');
        if (tHeadSummary) {
            tHeadSummary.style.display = 'table-row';
            tHeadSummary.cells[0].className = "bg-light border-bottom"; 
            tHeadSummary.cells[0].innerHTML = htmlResumenPaginado;
        }

        // Inyectar en el Footer (Paginado arriba y Badges abajo)
        const tFoot = document.getElementById('tFoot');
        if (tFoot) {
            tFoot.innerHTML = `
                <tr><td colspan="16" class="bg-light border-top">${htmlResumenPaginado}</td></tr>
                <tr><td colspan="16" class="bg-white border-top p-2">${contenedorBadges}</td></tr>
            `;
        }
    }

    function cambiarPagina(delta) {
        currentPage += delta;
        renderizarTabla(currentFiltered); // Redibujamos usando la data YA filtrada
        generarResumenReporte(currentFiltered.length); // Actualizamos botones
    }

    function cambiarItemsPorPagina(valor) {
        itemsPerPage = parseInt(valor);
        currentPage = 1; // Siempre reiniciamos a la página 1 para evitar errores
        renderizarTabla(currentFiltered);
        generarResumenReporte(currentFiltered.length);
    }
    
    function abrirVistaDetalles(isRefresh = false) {
        if(!isRefresh) { 
            document.getElementById('section-lista').style.display = 'none'; 
            document.getElementById('section-detalles').style.display = 'block'; 
        }
        
        const cont = document.getElementById('containerTablasDetalles'); 
        cont.innerHTML = "";
        
        const cats = [
            { label: 'Grupos', key: 'grupo_nom' }, 
            { label: 'Salas', key: 'sala_nom' }, 
            { label: 'Marcas', key: 'marca_nom' }, 
            { label: 'Modelos', key: 'modelo_nom' }, 
            { label: 'Juegos', key: 'juego_nom' }, 
            { label: 'Estados', key: 'estado_nom' }, 
            { label: 'Sociedades', key: 'sociedad_nom' }, 
            { label: 'Valores', key: 'valor_nom' },
            { label: 'Tipos', key: 'tipo_nom' },
            { label: 'Modos', key: 'modo_nom' },
            { label: 'Legal', key: 'legal_nom' }
        ];

        cats.forEach((c, index) => {
            // 1. Datos
            const count = {}; 
            currentFiltered.forEach(m => { 
                let l = (c.key === 'modelo_nom') ? `${m.modelo_nom || 'N/A'} (${m.marca_nom || 'N/A'})` : 
                        (c.key === 'sala_nom') ? `${m.sala_nom || 'N/A'} (${m.grupo_nom || 'N/A'})` : 
                        m[c.key] || 'N/A'; 
                count[l] = (count[l] || 0) + 1; 
            });
            
            const sorted = Object.entries(count).sort((a,b) => b[1] - a[1]);
            const totalItems = sorted.length;
            const uniqueId = `card_detail_${index}`; 

            // 2. VERIFICAMOS SI ESTABA ABIERTA (MEMORIA)
            const isExpanded = expandedCards.has(uniqueId);
            
            // Aplicamos la clase y el texto del botón según el estado guardado
            const currentClass = isExpanded ? 'table-container-full' : 'table-container-limit';
            const btnIcon = isExpanded ? 'bi-chevron-up' : 'bi-chevron-down';
            const btnText = isExpanded ? 'Ver menos' : `Ver todos (${totalItems})`;

            // Solo mostramos botón si hay más de 3 registros
            const showExpandBtn = totalItems > 3;

            let html = `
            <div class="col-md-3">
                <div class="card detail-card shadow-sm h-100">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light border-bottom">
                        <h6 class="m-0 text-primary fw-bold text-uppercase" style="font-size:0.75rem; background:none; padding:0;">
                            ${c.label}
                        </h6>
                        <span class="badge-counter fw-bold">${totalItems}</span>
                    </div>

                    <div class="card-body p-0">
                        <div id="cont_${uniqueId}" class="${currentClass}">
                            <table class="table detail-table table-sm table-hover mb-0">
                                <tbody>
                                    ${sorted.map(([n, ct]) => `
                                        <tr>
                                            <td class="ps-3 text-truncate" style="max-width: 180px;" title="${n}">${n}</td>
                                            <td class="text-center fw-bold text-primary pe-3" style="width:40px">${ct}</td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${showExpandBtn ? `
                    <div class="card-footer p-0 bg-white border-top-0 text-center">
                        <button onclick="toggleExpand('${uniqueId}')" id="btn_${uniqueId}" class="btn btn-link btn-sm text-decoration-none shadow-none" style="font-size:0.7rem; width:100%;">
                            <i class="bi ${btnIcon}"></i> ${btnText}
                        </button>
                    </div>` : ''}
                </div>
            </div>`;
            
            cont.innerHTML += html;
        });
    }

    function toggleExpand(id) {
        const container = document.getElementById(`cont_${id}`);
        const btn = document.getElementById(`btn_${id}`);
        
        if (container.classList.contains('table-container-limit')) {
            // ABRIR
            container.classList.remove('table-container-limit');
            container.classList.add('table-container-full');
            btn.innerHTML = '<i class="bi bi-chevron-up"></i> Ver menos';
            
            // Guardamos en memoria que esta tarjeta está abierta
            expandedCards.add(id);
        } else {
            // CERRAR
            container.classList.remove('table-container-full');
            container.classList.add('table-container-limit');
            // Recuperamos el número total del badge para volver a ponerlo en el botón si quieres, 
            // o dejamos el texto genérico para simplificar.
            // Truco: leemos el número del badge del mismo card para ponerlo en el botón
            const count = btn.closest('.card').querySelector('.badge-counter').innerText;
            btn.innerHTML = `<i class="bi bi-chevron-down"></i> Ver todos (${count})`;
            
            // Borramos de memoria
            expandedCards.delete(id);
        }
    }

    function cambiarVista(v) {
        
        vista = v; 
        // 1. GUARDAR EN MEMORIA (Esta es la línea mágica)
        localStorage.setItem('ultimaVista', vista);
        document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active-link'));
        const link = document.getElementById(`link-${v}`); if(link) link.classList.add('active-link');
        
        // Títulos
        const titulos = {
            'maquina': 'Inventario de Máquinas',
            'pianas': 'Gestión de Pianas por Sala' // Título personalizado
        };
        
        document.getElementById('viewTitle').innerText = titulos[v] || v.charAt(0).toUpperCase() + v.slice(1);
        document.getElementById('panelFiltros').style.display = (v === 'maquina') ? 'block' : 'none';
        document.getElementById('tHeadSummary').style.display = 'none'; document.getElementById('tFoot').innerHTML = "";

        aplicarPermisosUI(); 

        // --- LÓGICA BOTÓN NUEVO ---
        // Si es Pianas, ocultamos el botón de crear siempre. Si no, depende del nivel.
        const btnNuevo = document.getElementById('btn-nuevo-global');
        if (v === 'pianas') {
            btnNuevo.style.display = 'none';
        } else {
            // Restauramos la lógica original (Oculto si es nivel 3, visible si no)
            btnNuevo.style.display = (usuarioActual.nivel == 3) ? 'none' : 'block';
        }
        // --------------------------
        
        cancelarFormulario(); cerrarVistaDetalles(); cargarTabla();
    }

    async function abrirModalParametro(id = null) {
        editId = id; 
        const container = document.getElementById('modalFields');
        
        // 1. LIMPIEZA INMEDIATA (Spinner)
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small mt-2">Cargando...</div></div>';
        modalParam.show(); 

        try {
            let current = id ? await (await fetch(`${API}/${vista}/${id}`)).json() : {};
            let html = '';
            
            if (vista === 'usuario') {
                const isW = (current.usuario === 'willinthon');
                html = `<div class="mb-2"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div>
                        <div class="mb-2"><label class="filter-label">Usuario</label><input type="text" name="usuario" class="form-control" value="${current.usuario || ''}" required ${isW ? 'disabled' : ''}></div>
                        <div class="mb-2"><label class="filter-label">Clave</label><input type="password" name="clave" class="form-control" value="${current.clave || ''}" required></div>
                        <div class="mb-2"><label class="filter-label">Nivel</label><select name="nivel" class="form-select" ${isW ? 'disabled' : ''}><option value="1" ${current.nivel==1?'selected':''}>Admin</option><option value="2" ${current.nivel==2?'selected':''}>Supervisor</option><option value="3" ${current.nivel==3?'selected':''}>Normal</option></select></div>
                        ${isW ? '<input type="hidden" name="usuario" value="willinthon"><input type="hidden" name="nivel" value="1">' : ''}`;
            } else if (vista === 'pianas') {
                    // --- FORMULARIO SOLO PARA PIANAS ---
                    html = `
                        <div class="alert alert-info py-2 small mb-3">
                            Defina la cantidad de pianas para la sala <b>${current.nombre}</b>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Nombre Sucursal</label>
                            <input type="text" class="form-control" value="${current.nombre}" disabled readonly>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Pianas Normales ( 1x1 )</label>
                            <input type="number" name="pianas" class="form-control fw-bold text-primary" 
                                value="${current.pianas || 0}" min="0" required autofocus>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Pianas Grandes ( 1x3 )</label>
                            <input type="number" name="pianas_xl" class="form-control fw-bold text-primary"" 
                                value="${current.pianas_xl || 0}" min="0" required autofocus>
                        </div>
                    `;
                    // -----------------------------------
            } else {
                const d = {'sucursal':[{l:'Grupo',t:'grupo',f:'grupo_id'}],'modelo':[{l:'Marca',t:'marca',f:'marca_id'}]};
                html = `<div class="mb-3"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div>`;
                
                if (d[vista]) { 
                    for (let x of d[vista]) { 
                        // Pedimos data fresca
                        const res = await fetch(`${API}/options/${x.t}?userId=${usuarioActual.id}`);
                        const o = await res.json();
                        html += `<div class="mb-3"><label class="filter-label">${x.l}</label><select name="${x.f}" class="form-select" required><option value="">--</option>${o.map(opt => `<option value="${opt.id}" ${current[x.f] == opt.id ? 'selected' : ''}>${opt.nombre}</option>`).join('')}</select></div>`; 
                    } 
                }
            }
            
            container.innerHTML = html; 
            if(vista === 'usuario') { activarValidacionEnInput('input[name="usuario"]', 'usuario', 'usuario', 'btnGuardarParam', id); }
            
        } catch(e) {
            container.innerHTML = '<p class="text-danger text-center">Error al cargar datos.</p>';
        }
    }   
    
    async function abrirEditorMaquina(id = null) {
        editId = id; 
        document.getElementById('section-lista').style.display = 'none'; 
        document.getElementById('section-formulario').style.display = 'block';
        
        const container = document.getElementById('camposMaquina');

        // 1. LIMPIEZA TOTAL E INMEDIATA
        // Esto evita el "efecto fantasma" de ver datos viejos.
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <h6 class="text-muted fw-bold mt-2">Cargando datos frescos...</h6>
            </div>`;

        try {
            // 2. Cargar datos del registro (si es edición)
            let current = { puestos: 1 };
            if (id) {
                const res = await fetch(`${API}/maquina/${id}`);
                current = await res.json();
            }

            // 3. Construcción del HTML inicial
            let html = `
                <div class="col-md-4 mb-2">
                    <label class="filter-label">Nombre</label>
                    <input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required>
                </div>
                <div class="col-md-4 mb-2">
                    <label class="filter-label">Serial</label>
                    <input type="text" name="serial" class="form-control" value="${current.serial || ''}" placeholder="Dejar vacío para N/A">
                </div>
                <div class="col-md-4 mb-2">
                    <label class="filter-label">Puestos</label>
                    <input type="number" id="inputPuestos" name="puestos" class="form-control" value="${current.puestos || 1}" min="1" required>
                </div>`;

            const dMaq = [
                { label: 'Sala / Grupo', table: 'sucursal', fk: 'sucursal_id', grouped: true }, 
                { label: 'Marca / Modelo', table: 'modelo', fk: 'modelo_id', grouped: true }, 
                { label: 'Juego', table: 'juego', fk: 'juego_id' }, 
                { label: 'Estado', table: 'estado', fk: 'estado_id' }, 
                { label: 'Sociedad', table: 'sociedad', fk: 'sociedad_id' }, 
                { label: 'Valor', table: 'valor', fk: 'valor_id' },
                { label: 'Tipo', table: 'tipo', fk: 'tipo_id' },
                { label: 'Modo', table: 'modo', fk: 'modo_id' },
                { label: 'Legal', table: 'legal', fk: 'legal_id' },
            ];

            // 4. Ciclo de Carga (Sin Caché, siempre fresco)
            for (let d of dMaq) {
                // Pedimos la lista al servidor CADA VEZ que entramos
                const res = await fetch(`${API}/options/${d.table}?userId=${usuarioActual.id}`);
                const opts = await res.json();
                
                html += `<div class="col-md-4 mb-2"><label class="filter-label">${d.label}</label><select name="${d.fk}" class="form-select" required><option value="">--</option>`;
                
                if (d.grouped) { 
                    const g = {}; 
                    opts.forEach(o => { 
                        const p = o.parent_nom || 'Otros'; 
                        if (!g[p]) g[p] = []; 
                        g[p].push(o); 
                    }); 
                    for (const p in g) { 
                        html += `<optgroup label="${p.toUpperCase()}">`; 
                        g[p].forEach(o => { 
                            html += `<option value="${o.id}" ${current[d.fk] == o.id ? 'selected' : ''}>${o.nombre}</option>`; 
                        }); 
                        html += `</optgroup>`; 
                    }
                } else { 
                    html += opts.map(o => `<option value="${o.id}" ${current[d.fk] == o.id ? 'selected' : ''}>${o.nombre}</option>`).join(''); 
                } 
                html += `</select></div>`;
            }

            // 5. Inyectar HTML final
            container.innerHTML = html;

            // 6. Re-aplicar lógicas (Puestos y Validación)
            const selectTipo = document.querySelector('select[name="tipo_id"]');
            const inputPuestos = document.getElementById('inputPuestos');

            if (selectTipo && inputPuestos) {
                const aplicarReglaPuestos = () => {
                    const textoTipo = selectTipo.options[selectTipo.selectedIndex]?.text.toUpperCase() || "";
                    if (textoTipo === "NORMAL") {
                        inputPuestos.value = 1; inputPuestos.min = 1; inputPuestos.readOnly = true; inputPuestos.classList.add('bg-light');
                    } else if (textoTipo === "MULTIPUESTO") {
                        inputPuestos.readOnly = false; inputPuestos.min = 2; inputPuestos.classList.remove('bg-light');
                        if (parseInt(inputPuestos.value) < 2) inputPuestos.value = 2;
                    } else {
                        inputPuestos.readOnly = false; inputPuestos.min = 1; inputPuestos.classList.remove('bg-light');
                    }
                };
                selectTipo.addEventListener('change', aplicarReglaPuestos);
                setTimeout(aplicarReglaPuestos, 100); 
            }

            activarValidacionEnInput('input[name="serial"]', 'maquina', 'serial', 'btnGuardarMaquina', id);

        } catch (err) {
            container.innerHTML = `<div class="text-danger p-3 text-center">Error al conectar con el servidor. Intente de nuevo.</div>`;
            console.error(err);
        }
    }
    
    document.getElementById('formLogin').onsubmit = async (e) => { e.preventDefault(); try { const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ usuario: document.getElementById('log-user').value, clave: document.getElementById('log-pass').value }) }); const data = await res.json(); if (data.success) { localStorage.setItem('usuarioInventario', JSON.stringify(data.user)); verificarSesion(); } else { const err = document.getElementById('loginError'); err.innerText = data.message; err.style.display = 'block'; } } catch(e) { alert("Error de conexión"); } };
    document.getElementById('formParam').onsubmit = async (e) => { 
        e.preventDefault(); 
        await fetch(editId ? `${API}/${vista}/${editId}` : `${API}/${vista}`, { 
            method: editId ? 'PUT' : 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(Object.fromEntries(new FormData(e.target))) 
        }); 
        modalParam.hide(); 
        cargarTabla(); 
    };
    document.getElementById('formMaquinaFull').onsubmit = async (e) => { e.preventDefault(); await fetch(editId ? `${API}/maquina/${editId}` : `${API}/maquina`, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(e.target))) }); cancelarFormulario(); cargarTabla(); };

    function solicitarEliminar(id, tabla) { targetDelete = { id, tabla }; modalConfirm.show(); }

    document.getElementById('btnConfirmarAccion').onclick = async () => {
        const res = await fetch(`${API}/${targetDelete.tabla}/${targetDelete.id}`, { method: 'DELETE' });
        modalConfirm.hide();
        if (res.status === 409) { 
            const data = await res.json(); 
            document.getElementById('msgErrorRelacion').innerText = data.message; 
            setTimeout(() => modalError.show(), 300); 
        } else if (res.ok) { 
            cargarTabla(); 
        }
    };


    function cerrarSesion() { 
        // BORRAR LA VISTA GUARDADA
        localStorage.removeItem('ultimaVista');
        localStorage.removeItem('usuarioInventario'); 
        usuarioActual = null; 
        document.getElementById('view-app').style.display = 'none'; 
        document.getElementById('view-login').style.display = 'flex'; 
    }
    function cancelarFormulario() { document.getElementById('section-formulario').style.display = 'none'; document.getElementById('section-lista').style.display = 'block'; }
    function cerrarVistaDetalles() { document.getElementById('section-detalles').style.display = 'none'; document.getElementById('section-lista').style.display = 'block'; }
    
    function resetFiltros() {
        document.getElementById('f-nombre').value = "";
        document.getElementById('f-serial').value = "";
        Object.keys(estadoFiltros).forEach(k => estadoFiltros[k] = []);
        renderizarFiltrosMultiselect();
        aplicarFiltros();
    }

    function controladorAccionNuevo() { if(vista === 'maquina') abrirEditorMaquina(); else abrirModalParametro(); }
    async function exportarExcel() {
        if (currentFiltered.length === 0) return alert("No hay datos para exportar");

        const workbook = new ExcelJS.Workbook();
        
        // --- FUNCIÓN HELPER ---
        const agregarHoja = async (nombreHoja, datos) => {
            const safeName = (nombreHoja || "Sin Sala").substring(0, 30).replace(/[\/\\\?\*\]\[]/g, '-');
            const worksheet = workbook.addWorksheet(safeName);

            // 1. Columnas
            worksheet.columns = [
                { header: 'NOMBRE', key: 'nombre' },
                { header: 'SERIAL', key: 'serial' },
                { header: 'MARCA', key: 'marca' },
                { header: 'MODELO', key: 'modelo' },
                { header: 'JUEGO', key: 'juego' },
                { header: 'TIPO', key: 'tipo' },
                { header: 'PUESTOS', key: 'puestos' },
                { header: 'MODO', key: 'modo' },
                { header: 'SOCIEDAD', key: 'sociedad' },
                { header: 'VALOR', key: 'valor' },
                { header: 'ESTADO', key: 'estado' },
                { header: 'LEGAL', key: 'legal' },
                { header: 'GRUPO', key: 'grupo' },
                { header: 'SALA', key: 'sala' }
            ];

            // 2. Datos
            datos.forEach(m => {
                worksheet.addRow({
                    nombre: (m.nombre || "").toUpperCase(),
                    serial: (m.serial || "N/A").toUpperCase(),
                    marca: (m.marca_nom || "").toUpperCase(),
                    modelo: (m.modelo_nom || "").toUpperCase(),
                    juego: (m.juego_nom || "").toUpperCase(),
                    tipo: (m.tipo_nom || "").toUpperCase(),
                    puestos: m.puestos || 1,
                    modo: (m.modo_nom || "").toUpperCase(),
                    sociedad: (m.sociedad_nom || "").toUpperCase(),
                    valor: (m.valor_nom || "").toUpperCase(),
                    estado: (m.estado_nom || "").toUpperCase(),
                    legal: (m.legal_nom || "NO").toUpperCase(),
                    grupo: (m.grupo_nom || "").toUpperCase(),
                    sala: (m.sala_nom || "").toUpperCase()
                });
            });

            // 3. ESTILO ENCABEZADO (Solo visual, sin función de filtro)
            const headerRow = worksheet.getRow(1);
            headerRow.height = 30; 
            
            headerRow.eachCell((cell) => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E78' } }; 
                cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 14, name: 'Calibri' };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                
                // Bloqueamos encabezados
                cell.protection = { locked: true }; 
            });

            // 4. ESTILO ZEBRA Y DESBLOQUEO DE DATOS
            worksheet.eachRow((row, rowNumber) => {
                if (rowNumber > 1) { 
                    row.eachCell({ includeEmpty: true }, (cell) => {
                        cell.border = { 
                            top: {style:'thin', color: {argb:'FFD9D9D9'}}, 
                            left: {style:'thin', color: {argb:'FFD9D9D9'}}, 
                            bottom: {style:'thin', color: {argb:'FFD9D9D9'}}, 
                            right: {style:'thin', color: {argb:'FFD9D9D9'}} 
                        };
                        if (rowNumber % 2 === 0) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEBF1DE' } };
                        }
                        // Desbloqueamos datos
                        cell.protection = { locked: false };
                    });
                }
            });

            // 5. AUTO-AJUSTE
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, function(cell) {
                    let cellLength = cell.value ? cell.value.toString().length : 0;
                    if (cell.row === 1) cellLength += 5; 
                    if (cellLength > maxLength) maxLength = cellLength;
                });
                column.width = maxLength < 12 ? 12 : maxLength + 2; 
            });

            // --- CAMBIO PRINCIPAL: ELIMINAMOS "worksheet.autoFilter" ---
            // Al borrar esa línea, las flechas desaparecen.

            // 6. PROTECCIÓN (Sin AutoFilter activado)
            await worksheet.protect('25047058', {
                selectLockedCells: true,   
                selectUnlockedCells: true, 
                formatColumns: true,       
                formatRows: true,
                // autoFilter: true,  <-- Como no pusimos el rango arriba, esto ya no hace falta activarlo
                sort: true                 
            });
        };

        // --- GENERACIÓN ---
        await agregarHoja("Todas las Salas", currentFiltered);

        const salasUnicas = [...new Set(currentFiltered.map(item => item.sala_nom || "Sin Asignar"))];
        for (const sala of salasUnicas) {
            const datosSala = currentFiltered.filter(item => (item.sala_nom || "Sin Asignar") === sala);
            if (datosSala.length > 0) {
                await agregarHoja(sala, datosSala);
            }
        }

        // --- DESCARGA ---
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        const hoy = new Date();
        const fechaStr = hoy.toLocaleDateString().replace(/\//g, '-');
        const horaStr = hoy.getHours() + "h" + hoy.getMinutes();
        anchor.download = `Inventario_Maquinas_${fechaStr}_${horaStr}.xlsx`;
        anchor.click();
        window.URL.revokeObjectURL(url);
    }

    function exportarPDF() {
        if (currentFiltered.length === 0) return alert("No hay datos para exportar");

        const { jsPDF } = window.jspdf;
        
        // 1. Crear documento en HORIZONTAL
        const doc = new jsPDF('landscape', 'mm', 'a4');

        // 2. Encabezado del Reporte
        const hoy = new Date();
        const fechaStr = hoy.toLocaleDateString();
        const horaStr = hoy.getHours() + ":" + hoy.getMinutes();
        
        // Título Principal
        doc.setFontSize(16);
        doc.setTextColor(31, 78, 120); // Azul corporativo
        doc.setFont("helvetica", "bold");
        doc.text("Reporte de Inventario de Máquinas", 10, 15); // Margen izquierdo reducido
        
        // Subtítulo con fecha
        doc.setFontSize(9);
        doc.setTextColor(100);
        doc.setFont("helvetica", "normal");
        doc.text(`Generado el: ${fechaStr} a las ${horaStr} | Registros: ${currentFiltered.length}`, 10, 20);

        // 3. Definir Columnas y Mapear Data
        const columns = [
            { header: 'NOMBRE', dataKey: 'nombre' },
            { header: 'SERIAL', dataKey: 'serial' },
            { header: 'MARCA', dataKey: 'marca' },
            { header: 'MODELO', dataKey: 'modelo' },
            { header: 'JUEGO', dataKey: 'juego' },
            { header: 'TIPO', dataKey: 'tipo' },
            { header: 'PUESTOS', dataKey: 'puestos' },
            { header: 'MODO', dataKey: 'modo' },
            { header: 'SOCIEDAD', dataKey: 'sociedad' }, 
            { header: 'VALOR', dataKey: 'valor' },
            { header: 'ESTADO', dataKey: 'estado' },
            { header: 'LEGAL', dataKey: 'legal' },
            { header: 'GRUPO', dataKey: 'grupo' },
            { header: 'SALA', dataKey: 'sala' }
        ];

        const rows = currentFiltered.map(m => ({
            nombre: (m.nombre || "").toUpperCase(),
            serial: (m.serial || "N/A").toUpperCase(),
            marca: (m.marca_nom || "").toUpperCase(),
            modelo: (m.modelo_nom || "").toUpperCase(),
            juego: (m.juego_nom || "").toUpperCase(),
            tipo: (m.tipo_nom || "").toUpperCase(),
            puestos: m.puestos || 1,
            modo: (m.modo_nom || "").toUpperCase(),
            sociedad: (m.sociedad_nom || "").toUpperCase(),
            valor: (m.valor_nom || "").toUpperCase(),
            estado: (m.estado_nom || "").toUpperCase(),
            legal: (m.legal_nom || "NO").toUpperCase(),
            grupo: (m.grupo_nom || "").toUpperCase(),
            sala: (m.sala_nom || "").toUpperCase()
        }));

        // 4. GENERAR TABLA AUTO-AJUSTABLE
        doc.autoTable({
            columns: columns,
            body: rows,
            startY: 25,
            
            // --- MÁRGENES ESTRECHOS (Para aprovechar la hoja) ---
            margin: { top: 25, left: 5, right: 5, bottom: 10 },

            // --- ESTILOS GENERALES (Compactos) ---
            theme: 'grid',
            styles: {
                fontSize: 6.5,       // <--- Letra pequeña para que quepa todo
                cellPadding: 1.5,    // <--- Menos relleno para ahorrar espacio
                valign: 'middle',
                overflow: 'linebreak', // <--- Importante: Texto largo salta de línea
                lineWidth: 0.1,      // Líneas finas
                lineColor: [200, 200, 200]
            },

            // --- ESTILO ENCABEZADO ---
            headStyles: { 
                fillColor: [31, 78, 120], 
                textColor: 255, 
                fontSize: 7,         // Título un pelín más grande que el texto
                fontStyle: 'bold',
                halign: 'center',
                valign: 'middle'
            },

            // --- ESTILO FILAS (Cebra) ---
            alternateRowStyles: { 
                fillColor: [240, 245, 235] // Un verde/gris muy pálido para leer mejor
            },

            // --- ANCHOS DE COLUMNA PERSONALIZADOS ---
            // Aquí distribuimos los 287mm disponibles (297mm hoja - 10mm márgenes)
            columnStyles: {
                nombre:    { cellWidth: 'auto', fontStyle: 'bold' }, // El más importante
                serial:    { cellWidth: 'auto' },
                marca:     { cellWidth: 'auto' },
                modelo:    { cellWidth: 'auto' },
                juego:     { cellWidth: 'auto' }, // Juegos suelen tener nombres largos
                tipo:      { cellWidth: 'auto' },
                puestos:   { cellWidth: 'auto' }, // Muy pequeño
                modo:      { cellWidth: 'auto' },
                sociedad:  { cellWidth: 'auto' },
                valor:     { cellWidth: 'auto' },
                estado:    { cellWidth: 'auto' },
                legal:     { cellWidth: 'auto' },
                grupo:     { cellWidth: 'auto' },
                sala:      { cellWidth: 'auto' } // El resto del espacio para la sala
            }
        });

        // 5. Guardar
        const nombreArchivo = `Inventario_Maquinas_${fechaStr.replace(/\//g, '-')}.pdf`;
        doc.save(nombreArchivo);
    }
    

    async function imprimirEtiqueta(id) {
    // 1. Buscar la data
    const maquina = allData.find(m => m.id === id);
    if (!maquina) {
        console.error("Máquina no encontrada para imprimir ID:", id);
        return;
    }

    // 2. Crear contenedor temporal fuera de pantalla
    // Usamos este contenedor para "dibujar" la etiqueta en alta resolución
    const container = document.createElement('div');
    container.id = 'temp-hires-label-container';
    container.style.position = 'fixed';
    container.style.left = '-9999px';
    container.style.top = '0';
    container.style.zIndex = '-1';
    container.style.backgroundColor = 'white';
    
    // --- AQUÍ ESTÁ LA CLAVE: EL DISEÑO EXACTO DE TU IMAGEN ---
    // Se han usado estilos específicos para forzar blanco y negro puro y evitar suavizado.
    container.innerHTML = `
        <div style="
            width: 57mm;
            height: 32mm;
            padding: 0.5mm 2mm; /* Padding original */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            background: white;
            color: black;
            font-family: 'Courier New', Courier, monospace; /* Fuente monoespaciada para mejor definición térmica */
            -webkit-font-smoothing: none; /* Desactiva suavizado */
        ">
            <div style="
                font-size: 10pt; 
                font-weight: 900; 
                text-align: center; 
                border-bottom: 2px solid black; /* Línea gruesa como en la foto */
                margin-bottom: 0.5mm;
                display: flex;
                justify-content: space-between;
            ">
                
                <span>${maquina.nombre.toUpperCase()}</span>
                <span>${maquina.serial || 'N/A'}</span>
            </div>

            <div style="
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                justify-content: flex-start; /* Alineado arriba */
                font-size: 9pt; /* Tamaño ajustado para lectura clara */
                line-height: 1.2;
                font-weight: bold;
                overflow: hidden;
                white-space: nowrap;
            ">
                <div>MARCA: ${maquina.marca_nom || '-'}</div>
                <div>MODELO: ${maquina.modelo_nom || '-'}</div>
                <div>TIPO: ${maquina.tipo_nom || '-'} | MODO: ${maquina.modo_nom || '-'}</div>
                <div>SOC: ${maquina.sociedad_nom || '-'} | VALOR: ${maquina.valor_nom || '-'}</div>
                <div style="
                     font-size: 7pt; 
                     text-align: center; 
                ">                  
                    ${maquina.juego_nom || '-'}</div>
                </div>

            <div style="
                font-size: 9pt; 
                border-top: 2px solid black; /* Línea gruesa */
                padding-top: 0.5mm;
                display: flex;
                justify-content: space-between;
                font-weight: 900;
                margin-top: auto;
            ">
                <span>${maquina.sala_nom || '-'}</span>
                <span>ID:${maquina.id}</span>
            </div>
        </div>
    `;
    
    document.body.appendChild(container);

    try {
        // 3. Generar Imagen de Alta Definición (Scale 4 = Muy nítido)
        // Necesitas tener cargada la librería html2canvas en tu proyecto
        const canvas = await html2canvas(container.firstElementChild, {
            scale: 4, 
            logging: false,
            useCORS: true,
            backgroundColor: '#ffffff' // Asegura fondo blanco puro
        });
        
        const imgData = canvas.toDataURL('image/png');
        
        // Limpieza del DOM
        document.body.removeChild(container);

        // 4. Preparar el iframe de impresión
        let iframe = document.getElementById('print-frame');
        if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = 'print-frame';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
        }

        // Contenido del iframe: Solo la imagen generada
        const content = `
            <html>
            <head>
                <style>
                    @page { size: 57mm 32mm; margin: 0mm; }
                    body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center;}
                    /* pixelated evita que el navegador intente suavizar la imagen de nuevo */
                    img { width: 57mm; height: 32mm; display: block; image-rendering: pixelated; }
                </style>
            </head>
            <body>
                <img src="${imgData}" onload="window.focus(); setTimeout(()=> window.print(), 200);" />
            </body>
            </html>
        `;

        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
        // El window.print() se dispara automáticamente en el onload de la imagen arriba

    } catch (error) {
        console.error("Error generando la impresión:", error);
        // Limpieza de emergencia si falla
        const tempContainer = document.getElementById('temp-hires-label-container');
        if (tempContainer) document.body.removeChild(tempContainer);
    }
}



    
    // --- PEGA AQUÍ LOS LISTENERS DE LOS CAMPOS DE TEXTO ---
    const inputNombre = document.getElementById('f-nombre');
    const inputSerial = document.getElementById('f-serial');
    
    if(inputNombre) inputNombre.addEventListener('keyup', aplicarFiltros);
    if(inputSerial) inputSerial.addEventListener('keyup', aplicarFiltros);

    // ------------------------------------------------------

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW fail', err));
      });
    }
    
    verificarSesion();
</script>
</body>
</html>