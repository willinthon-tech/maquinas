<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventario Global de Maquinas</title>
    <link rel="icon" type="image/png" href="/logo_wisi.png">
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <meta name="theme-color" content="#1a1a27">
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow: hidden; margin: 0; }
        #view-login { height: 100vh; display: flex; align-items: center; justify-content: center; background: #1a1a27; }
        .login-card { width: 360px; border-radius: 12px; border: none; }
        #view-app { display: none; height: 100vh; width: 100%; }
        #sidebar { width: 230px; background: #1a1a27; padding: 15px; flex-shrink: 0; display: flex; flex-direction: column; }
        #sidebar .brand { color: white; text-align: center; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #2b2b40; padding-bottom: 15px; margin-bottom: 20px; font-size: 0.9rem; }
        #sidebar a { color: #92929f; display: block; padding: 10px; text-decoration: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; }
        #sidebar a:hover, .active-link { background: #2b2b40; color: #009ef7 !important; }
        .sidebar-user-info { padding: 12px 10px; text-align: center; border-top: 1px solid #2b2b40; margin-top: auto; background: #1e1e2d; border-radius: 8px; cursor: pointer; }
        .user-name { color: white; font-size: 0.85rem; font-weight: 600; display: block; }
        .user-level { color: #009ef7; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 10px; }
        .btn-logout { color: #f1416c !important; border: 1px solid #f1416c; font-size: 0.75rem; font-weight: bold; }
        #main { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .table { font-size: 0.76rem; vertical-align: middle; }
        .table thead th { background: #f1f1f4; text-transform: uppercase; font-size: 0.68rem; padding: 10px 5px; }
        .report-summary-row td, .table tfoot td { background: #e1e3ea !important; padding: 10px 15px; font-size: 0.75rem; border-top: 2px solid #ced4da; }
        .btn-action { padding: 3px 10px; font-size: 0.7rem; font-weight: 600; }
        .filter-label { font-size: 0.65rem; font-weight: bold; color: #5e6278; text-transform: uppercase; }
        .form-filter { font-size: 0.75rem; height: 32px; }
        .detail-card { border: 1px solid #ebedef; border-radius: 6px; background: white; margin-bottom: 10px; }
        .detail-card h6 { font-size: 0.7rem; font-weight: 800; background: #f4f4f7; padding: 10px; margin: 0; color: #009ef7; text-transform: uppercase; }
        .is-invalid { border-color: #dc3545 !important; background-image: none !important; }
        .feedback-error { color: #dc3545; font-size: 0.7rem; margin-top: 2px; font-weight: bold; display: none; }

        /* Transición suave para expandir/colapsar */
        .table-container-limit {
            max-height: 160px; /* Altura inicial fija */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .table-container-full {
            max-height: 1000px; /* Altura suficiente para mostrar todo */
            overflow-y: auto;
        }

        /* Estilo del badge del contador */
        .badge-counter {
            background-color: #eef2f5; 
            color: #1F4E78; 
            border: 1px solid #1F4E78;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.7rem;
        }

    </style>
</head>
<body>

<div id="view-login">
    <div class="card login-card p-4 text-center">
        <h4 class="fw-bold">BIENVENIDO</h4>
        <p class="text-muted small">Inventario Global de Maquinas</p>
        <form id="formLogin">
            <div class="text-start mb-3"><label class="filter-label">Usuario</label><input type="text" id="log-user" class="form-control" required></div>
            <div class="text-start mb-3"><label class="filter-label">Clave</label><input type="password" id="log-pass" class="form-control" required></div>
            <div id="loginError" class="alert alert-danger p-2 small mb-3" style="display:none;"></div>
            <button type="submit" class="btn btn-primary w-100 fw-bold">ENTRAR</button>
        </form>
    </div>
</div>

<div id="view-app">
    <nav id="sidebar">
        <div class="brand">Inventario Global<br>de Maquinas</div>
        <a onclick="cambiarVista('maquina')" id="link-maquina">Máquinas</a>
        <div id="menu-admin-only">
            <hr style="border-color: #2b2b40;">
            <a onclick="cambiarVista('grupo')" id="link-grupo">Grupos</a>
            <a onclick="cambiarVista('sucursal')" id="link-sucursal">Sucursales</a>
            <a onclick="cambiarVista('estado')" id="link-estado">Estados</a>
            <a onclick="cambiarVista('sociedad')" id="link-sociedad">Sociedades</a>
            <a onclick="cambiarVista('valor')" id="link-valor">Valores</a>
            <a onclick="cambiarVista('juego')" id="link-juego">Juegos</a>
            <a onclick="cambiarVista('marca')" id="link-marca">Marcas</a>
            <a onclick="cambiarVista('modelo')" id="link-modelo">Modelos</a>
            <a onclick="cambiarVista('tipo')" id="link-tipo">Tipos</a>
            <a onclick="cambiarVista('modo')" id="link-modo">Modos</a>
            <a onclick="cambiarVista('legal')" id="link-legal">Legal</a>
        </div>
        <div class="sidebar-user-info" onclick="irAVistaUsuarios()">
            <span class="user-name" id="display-user-name">---</span>
            <span class="user-level" id="display-user-level">---</span>
            <a onclick="event.stopPropagation(); cerrarSesion();" class="btn btn-logout w-100 mt-2">Cerrar Sesión</a>
        </div>
    </nav>

    <main id="main">
        <div id="section-lista">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="viewTitle" class="fw-bold m-0 text-dark">Máquinas</h5>
                <button class="btn btn-success btn-action px-4" id="btn-nuevo-global" onclick="controladorAccionNuevo()">Nuevo Registro</button>
            </div>
            <div class="card mb-3" id="panelFiltros" style="display:none;">
                <div class="card-body p-3">
                    <div class="row g-2">
                        <div class="col-md-3"><label class="filter-label">Nombre</label><input type="text" id="f-nombre" class="form-control form-filter shadow-none"></div>
                        <div class="col-md-3"><label class="filter-label">Serial</label><input type="text" id="f-serial" class="form-control form-filter shadow-none"></div>
                        <div class="col-md-3"><label class="filter-label">Sociedad</label><select id="f-sociedad" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-3"><label class="filter-label">Legal</label><select id="f-legal" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4"><label class="filter-label">Marca</label><select id="f-marca" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-4"><label class="filter-label">Modelo</label><select id="f-modelo" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-4"><label class="filter-label">Juego</label><select id="f-juego" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-2"><label class="filter-label">Grupo</label><select id="f-grupo" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-2"><label class="filter-label">Sala</label><select id="f-sucursal" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-2"><label class="filter-label">Estado</label><select id="f-estado" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-2"><label class="filter-label">Valor</label><select id="f-valor" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-2"><label class="filter-label">Tipo</label><select id="f-tipo" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                        <div class="col-md-2"><label class="filter-label">Modo</label><select id="f-modo" class="form-select form-filter shadow-none"><option value="">TODOS</option></select></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4 mt-3"><button class="btn btn-secondary btn-action w-100" onclick="resetFiltros()">Limpiar</button></div>
                        <div class="col-md-4 mt-3"><button class="btn btn-warning btn-action w-100 fw-bold" onclick="exportarExcel()">Excel</button></div>
                        <div class="col-md-4 mt-3">
                            <button class="btn btn-danger btn-action w-100 fw-bold" onclick="exportarPDF()">
                                <i class="bi bi-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow-sm"><div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead id="tHead"><tr id="tHeadSummary" class="report-summary-row" style="display:none;"><td colspan="16"></td></tr><tr id="tHeadTitles" class="table-light"></tr></thead>
                    <tbody id="tBody"></tbody><tfoot id="tFoot"></tfoot>
                </table>
            </div></div>
        </div>
        <div id="section-detalles" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Análisis Detallado</h5><button class="btn btn-dark btn-sm" onclick="cerrarVistaDetalles()">Volver</button></div>
            <div class="alert alert-primary py-2 x-small mb-3 shadow-sm" id="alertFiltrosDetalles"></div>
            <div class="row g-3" id="containerTablasDetalles"></div>
        </div>
        <div id="section-formulario" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5>Gestión</h5><button class="btn btn-sm btn-outline-secondary" onclick="cancelarFormulario()">Volver</button></div>
            <div class="card"><div class="card-body"><form id="formMaquinaFull"><div class="row" id="camposMaquina"></div><hr><div class="text-end"><button type="submit" id="btnGuardarMaquina" class="btn btn-primary px-5">Guardar</button></div></form></div></div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalParam" data-bs-backdrop="static"><div class="modal-dialog"><form id="formParam" class="modal-content"><div class="modal-header border-0"><h6>Nuevo Registro</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modalFields"></div><div class="modal-footer border-0"><button type="submit" id="btnGuardarParam" class="btn btn-primary w-100">Guardar</button></div></form></div></div>

<div class="modal fade" id="modalSucursales" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header border-0"><h6>Asignar Sucursales</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-muted">Marque las sucursales permitidas para este usuario:</p><div id="containerSucursales" style="max-height: 350px; overflow-y: auto;"></div></div><div class="modal-footer border-0"><button onclick="guardarSucursales()" class="btn btn-primary w-100 fw-bold">Guardar Permisos</button></div></div></div></div>

<div class="modal fade" id="modalConfirmarEliminar" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">Confirmar</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-muted mb-0">¿Estás seguro de eliminar este registro?</p></div><div class="modal-footer border-0 justify-content-center"><button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger btn-sm px-4" id="btnConfirmarAccion">Sí, Eliminar</button></div></div></div></div>

<div class="modal fade" id="modalErrorRelacion" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0 text-danger"><h6 class="modal-title fw-bold">Acción Denegada</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-muted mb-0" id="msgErrorRelacion"></p></div><div class="modal-footer border-0"><button type="button" class="btn btn-dark btn-sm w-100" data-bs-dismiss="modal">Entendido</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "/api"; 
    let vista = "maquina", allData = [], editId = null, currentFiltered = [], usuarioActual = null, refreshInt = null;
    let targetDelete = { id: null, tabla: null };
    let tempUserId = null; 

    const modalParam = new bootstrap.Modal(document.getElementById('modalParam'));
    const modalConfirm = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
    const modalError = new bootstrap.Modal(document.getElementById('modalErrorRelacion'));
    const modalSucursales = new bootstrap.Modal(document.getElementById('modalSucursales'));

    function aplicarPermisosUI() {
        if(!usuarioActual) return;
        document.getElementById('menu-admin-only').style.display = (usuarioActual.nivel == 1) ? 'block' : 'none';
        document.getElementById('btn-nuevo-global').style.display = (usuarioActual.nivel == 3) ? 'none' : 'block';
    }

    function verificarSesion() {
        const stored = localStorage.getItem('usuarioInventario');
        if (stored) {
            usuarioActual = JSON.parse(stored);
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-app').style.display = 'flex';
            actualizarInterfazPerfil();
            cambiarVista('maquina');
            iniciarRealTime();
        } else {
            detenerRealTime();
            document.getElementById('view-login').style.display = 'flex';
            document.getElementById('view-app').style.display = 'none';
        }
    }

    function actualizarInterfazPerfil() {
        const lvls = {1:'Administrador', 2:'Supervisor', 3:'Normal'};
        document.getElementById('display-user-name').innerText = usuarioActual.nombre;
        document.getElementById('display-user-level').innerText = lvls[usuarioActual.nivel] || 'Usuario';
    }

    function irAVistaUsuarios() { if(usuarioActual.nivel == 1) cambiarVista('usuario'); }

    function iniciarRealTime() {
        if(refreshInt) clearInterval(refreshInt);
        refreshInt = setInterval(async () => {
            if(!document.querySelector('.modal.show') && document.getElementById('section-formulario').style.display === 'none') {
                await cargarTabla();
                sincronizarUsuarioLogueado();
                if(document.getElementById('section-detalles').style.display === 'block') abrirVistaDetalles(true);
            }
        }, 5000);
    }

    async function sincronizarUsuarioLogueado() {
        try {
            const res = await fetch(`${API}/usuario/${usuarioActual.id}`);
            const data = await res.json();
            if(data.id) { usuarioActual = data; localStorage.setItem('usuarioInventario', JSON.stringify(data)); actualizarInterfazPerfil(); }
        } catch(e) {}
    }

    function detenerRealTime() { if(refreshInt) clearInterval(refreshInt); }

    async function cargarTabla() {
        const res = await fetch(`${API}/${vista}?userId=${usuarioActual.id}`);
        const data = await res.json();
        allData = Array.isArray(data) ? data : [];
        if (vista === 'maquina') aplicarFiltros(); else renderizarTabla(allData);
    }

    function aplicarFiltros() {
        if (vista !== 'maquina') return;
        const rawNombre = document.getElementById('f-nombre')?.value || "";
        const rawSerial = document.getElementById('f-serial')?.value || "";
        const fNombre = rawNombre.toLowerCase();
        const fSerial = rawSerial.toLowerCase();
        const getS = (id) => document.getElementById(id)?.value || "";
        const f = {
            Grupo: getS('f-grupo'), Sala: getS('f-sucursal'), Marca: getS('f-marca'),
            Modelo: getS('f-modelo'), Juego: getS('f-juego'), Estado: getS('f-estado'),
            Sociedad: getS('f-sociedad'), Valor: getS('f-valor'), Tipo: getS('f-tipo'), Modo: getS('f-modo'),  Legal: getS('f-legal')
        };
        currentFiltered = allData.filter(m => 
            ((m.nombre || "").toLowerCase().includes(fNombre)) && 
            ((m.serial || "").toLowerCase().includes(fSerial)) &&
            (f.Grupo === "" || (m.grupo_nom || "") === f.Grupo) &&
            (f.Sala === "" || (m.sala_nom || "") === f.Sala) &&
            (f.Marca === "" || (m.marca_nom || "") === f.Marca) &&
            (f.Modelo === "" || (m.modelo_nom || "") === f.Modelo) &&
            (f.Juego === "" || (m.juego_nom || "") === f.Juego) &&
            (f.Estado === "" || (m.estado_nom || "") === f.Estado) &&
            (f.Sociedad === "" || (m.sociedad_nom || "") === f.Sociedad) &&
            (f.Valor === "" || (m.valor_nom || "") === f.Valor) &&
            (f.Tipo === "" || (m.tipo_nom || "") === f.Tipo) &&
            (f.Modo === "" || (m.modo_nom || "") === f.Modo) &&
            (f.Legal === "" || (m.legal_nom || "") === f.Legal)
        );
        renderizarTabla(currentFiltered);
        actualizarDropdownsDinamicos(currentFiltered);
        generarResumenReporte(currentFiltered.length, { Nombre: rawNombre, Serial: rawSerial, ...f });
    }

    function renderizarTabla(data) {
        const titles = document.getElementById('tHeadTitles'), body = document.getElementById('tBody');
        const styleAcc = (usuarioActual.nivel == 3) ? 'display:none' : '';
        if(vista === 'maquina') {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>Serial</th><th>Grupo</th><th>Sala</th><th>Marca</th><th>Modelo</th><th>Juego</th><th>Estado</th><th>Soc.</th><th>Val.</th><th>Tipo</th><th>Puestos</th><th>Modo</th><th>Legal</th><th class="text-center" style="${styleAcc}">Acciones</th>`;
            // Dentro de renderizarTabla, en la sección de vista === 'maquina'
            body.innerHTML = data.map(i => {
                // Definimos el color del badge: si es N/A es rojo (danger), si no, es oscuro (dark)
                const badgeColor = (i.serial === 'N/A' || !i.serial) ? 'bg-danger' : 'bg-dark';

                return `
                    <tr>
                        <td>${i.id}</td>
                        <td><b>${i.nombre}</b></td>
                        <td><span class="badge ${badgeColor}">${i.serial || 'N/A'}</span></td>
                        <td>${i.grupo_nom || '-'}</td>
                        <td>${i.sala_nom || '-'}</td>
                        <td>${i.marca_nom || '-'}</td>
                        <td>${i.modelo_nom || '-'}</td>
                        <td>${i.juego_nom || '-'}</td>
                        <td>${i.estado_nom || '-'}</td>
                        <td>${i.sociedad_nom || '-'}</td>
                        <td>${i.valor_nom || '-'}</td>
                        <td>${i.tipo_nom || '-'}</td>
                        <td class="fw-bold text-center">${i.puestos || '1'}</td>
                        <td>${i.modo_nom || '-'}</td>
                        <td>${i.legal_nom || '-'}</td>
                        <td class="text-center" style="${styleAcc}">
                            <button onclick="abrirEditorMaquina(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> 
                            <button onclick="solicitarEliminar(${i.id}, 'maquina')" class="btn btn-outline-danger btn-action ms-1">Borrar</button>
                        </td>
                    </tr>`;
            }).join('');
        } else if (vista === 'sucursal' || vista === 'modelo') {
            const padre = (vista === 'sucursal') ? 'Grupo' : 'Marca';
            const nomPadre = (vista === 'sucursal') ? 'grupo_nom' : 'marca_nom';
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>${padre}</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => `<tr><td>${i.id}</td><td>${i.nombre}</td><td><span class="badge bg-light text-dark border">${i[nomPadre] || '-'}</span></td><td class="text-center"><button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> <button onclick="solicitarEliminar(${i.id}, '${vista}')" class="btn btn-outline-danger btn-action ms-1">Borrar</button></td></tr>`).join('');
        } else if (vista === 'usuario') {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>Usuario</th><th>Nivel</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => { 
                const l = {1:'Admin', 2:'Supervisor', 3:'Normal'}; 
                return `<tr>
                    <td>${i.id}</td>
                    <td>${i.nombre}</td>
                    <td>${i.usuario}</td>
                    <td><span class="badge bg-info text-dark">${l[i.nivel]}</span></td>
                    <td class="text-center">
                        <button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button>
                        <button onclick="abrirModalSucursales(${i.id})" class="btn btn-outline-warning btn-action ms-1">Sucursales</button>
                        ${(i.usuario === 'willinthon') ? '<button class="btn btn-outline-secondary btn-action ms-1" disabled>Lock</button>' : `<button onclick="solicitarEliminar(${i.id}, 'usuario')" class="btn btn-outline-danger btn-action ms-1">Borrar</button>`}
                    </td>
                </tr>`; 
            }).join('');
        } else {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => `<tr><td>${i.id}</td><td>${i.nombre}</td><td class="text-center"><button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> <button onclick="solicitarEliminar(${i.id}, '${vista}')" class="btn btn-outline-danger btn-action ms-1">Borrar</button></td></tr>`).join('');
        }
    }

    function activarValidacionEnInput(selectorInput, tabla, campo, btnGuardarId, idRegistro = null) {
        const input = document.querySelector(selectorInput);
        if (!input) return;
        if(input.parentNode.querySelector('.feedback-error')){ input.parentNode.querySelector('.feedback-error').remove(); }
        let errorMsg = document.createElement('div');
        errorMsg.className = 'feedback-error';
        errorMsg.innerText = `Este ${campo} ya existe en la base de datos.`;
        input.parentNode.appendChild(errorMsg);
        const btn = document.getElementById(btnGuardarId);
        input.classList.remove('is-invalid');
        errorMsg.style.display = 'none';
        if(btn) btn.disabled = false;
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        const activeInput = document.querySelector(selectorInput);
        if(!activeInput.parentNode.querySelector('.feedback-error')) { activeInput.parentNode.appendChild(errorMsg); }
        activeInput.addEventListener('keyup', async () => {
            const valor = activeInput.value.trim();

            // NUEVA EXCEPCIÓN PARA "N/A"
            if (campo === 'serial' && (valor === "" || valor.toUpperCase() === 'N/A')) {
                activeInput.classList.remove('is-invalid');
                errorMsg.style.display = 'none';
                if(btn) btn.disabled = false;
                return; // Detiene la validación aquí para que no consulte a la API
            }

            if (valor.length < 2) {
                 activeInput.classList.remove('is-invalid');
                 errorMsg.style.display = 'none';
                 if(btn) btn.disabled = false;
                 return; 
            }
            try {
                let url = `${API}/validar/${tabla}/${campo}/${valor}`;
                if(idRegistro) { url += `?excludeId=${idRegistro}`; }
                const res = await fetch(url);
                const data = await res.json();
                if (data.existe) {
                    activeInput.classList.add('is-invalid');
                    errorMsg.style.display = 'block';
                    if(btn) btn.disabled = true;
                } else {
                    activeInput.classList.remove('is-invalid');
                    errorMsg.style.display = 'none';
                    if(btn) btn.disabled = false;
                }
            } catch (e) { console.error(e); }
        });
    }

    async function abrirModalSucursales(userId) {
        tempUserId = userId;
        const container = document.getElementById('containerSucursales');
        container.innerHTML = `<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><span class="ms-2 small text-muted">Cargando lista completa...</span></div>`;
        modalSucursales.show();
        try {
            // CORRECCIÓN DEFINITIVA: Llamado sin userId para traer la lista completa
            const resAll = await fetch(`${API}/options/sucursal`);
            const resPerm = await fetch(`${API}/permisos_sucursal/${userId}`);
            
            if (!resAll.ok || !resPerm.ok) throw new Error("Error al obtener datos");
            const allSuc = await resAll.json();
            const userPerms = await resPerm.json();
            
            if(allSuc.length === 0){ container.innerHTML = '<p class="text-muted text-center small p-3">No hay sucursales registradas.</p>'; return; }
            
            let html = '';
            allSuc.forEach(s => {
                const isChecked = userPerms.includes(s.id) ? 'checked' : '';
                const grupoLabel = s.parent_nom ? `<span class="badge bg-secondary" style="font-size:0.6rem">${s.parent_nom}</span> ` : '';
                html += `
                    <div class="form-check border-bottom py-2 m-0">
                        <input class="form-check-input chk-sucursal" type="checkbox" value="${s.id}" id="chk_${s.id}" ${isChecked}>
                        <label class="form-check-label small w-100" for="chk_${s.id}" style="cursor:pointer">
                            ${grupoLabel} <b>${s.nombre}</b>
                        </label>
                    </div>`;
            });
            container.innerHTML = html;
        } catch(e) { container.innerHTML = '<p class="text-danger small text-center p-3">Error de conexión al cargar sucursales.</p>'; }
    }

    async function guardarSucursales() {
        const btn = document.querySelector('#modalSucursales .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "Guardando...";
        btn.disabled = true;
        try {
            const checkedBoxes = document.querySelectorAll('.chk-sucursal:checked');
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            const res = await fetch(`${API}/asignar_sucursales`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usuario_id: tempUserId, sucursales: selectedIds })
            });
            if(res.ok) { modalSucursales.hide(); } else { alert("Error al guardar."); }
        } catch(e) { alert("Error de conexión."); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

    function actualizarDropdownsDinamicos(data) {
        const conf = {'f-grupo':'grupo_nom','f-sucursal':'sala_nom','f-marca':'marca_nom','f-modelo':'modelo_nom','f-juego':'juego_nom','f-estado':'estado_nom','f-sociedad':'sociedad_nom','f-valor':'valor_nom','f-tipo':'tipo_nom','f-modo':'modo_nom','f-legal':'legal_nom'};
        Object.keys(conf).forEach(id => { 
            const s = document.getElementById(id); 
            if(!s || document.activeElement === s) return; 
            const v = s.value; 
            const u = [...new Set(data.map(i => i[conf[id]]))].filter(x => x).sort(); 
            s.innerHTML = '<option value="">TODOS</option>' + u.map(x => `<option value="${x}" ${x==v?'selected':''}>${x}</option>`).join(''); 
        });
    }

    function generarResumenReporte(total, filtros) {
        if (vista !== 'maquina') return;
        let aplicados = []; 
        for (const [k, v] of Object.entries(filtros)) { if (v !== "") aplicados.push(`${k}: ${v}`); }
        let txt = `Máquinas totales: ( <b>${total}</b> )`; if (aplicados.length > 0) txt += `, Filtros Totales: ( <b>${aplicados.length}</b> ), Filtros: ( ${aplicados.join(', ')} )`;
        const content = `<div class="d-flex align-items-center justify-content-between w-100"><div>${txt}</div><div><button class="btn btn-dark btn-action" onclick="abrirVistaDetalles()">Detalles</button></div></div>`;
        document.getElementById('tFoot').innerHTML = `<tr><td colspan="16">${content}</td></tr>`;
        document.getElementById('tHeadSummary').style.display = 'table-row'; document.getElementById('tHeadSummary').cells[0].innerHTML = content;
        document.getElementById('alertFiltrosDetalles').innerHTML = txt;
    }
    
    function abrirVistaDetalles(isRefresh = false) {
        if(!isRefresh) { 
            document.getElementById('section-lista').style.display = 'none'; 
            document.getElementById('section-detalles').style.display = 'block'; 
        }
        
        const cont = document.getElementById('containerTablasDetalles'); 
        cont.innerHTML = "";
        
        const cats = [
            { label: 'Grupos', key: 'grupo_nom' }, 
            { label: 'Salas', key: 'sala_nom' }, 
            { label: 'Marcas', key: 'marca_nom' }, 
            { label: 'Modelos', key: 'modelo_nom' }, 
            { label: 'Juegos', key: 'juego_nom' }, 
            { label: 'Estados', key: 'estado_nom' }, 
            { label: 'Sociedades', key: 'sociedad_nom' }, 
            { label: 'Valores', key: 'valor_nom' },
            { label: 'Tipos', key: 'tipo_nom' },
            { label: 'Modos', key: 'modo_nom' },
            { label: 'Legal', key: 'legal_nom' }
        ];

        cats.forEach((c, index) => {
            // 1. Contar elementos
            const count = {}; 
            currentFiltered.forEach(m => { 
                let l = (c.key === 'modelo_nom') ? `${m.modelo_nom || 'N/A'} (${m.marca_nom || 'N/A'})` : 
                        (c.key === 'sala_nom') ? `${m.sala_nom || 'N/A'} (${m.grupo_nom || 'N/A'})` : 
                        m[c.key] || 'N/A'; 
                count[l] = (count[l] || 0) + 1; 
            });
            
            const sorted = Object.entries(count).sort((a,b) => b[1] - a[1]);
            const totalItems = sorted.length; // Total de categorías únicas (ej: 5 marcas)
            const uniqueId = `card_detail_${index}`; // ID único para cada tarjeta

            // 2. Definir si necesita botón "Ver más" (si tiene más de 5 items)
            const showExpandBtn = totalItems > 5;

            // 3. Construir HTML
            let html = `
            <div class="col-md-3">
                <div class="card detail-card shadow-sm h-100">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light border-bottom">
                        <h6 class="m-0 text-primary fw-bold text-uppercase" style="font-size:0.75rem; background:none; padding:0;">
                            ${c.label}
                        </h6>
                        <span class="badge-counter fw-bold">${totalItems}</span>
                    </div>

                    <div class="card-body p-0">
                        <div id="cont_${uniqueId}" class="table-container-limit">
                            <table class="table detail-table table-sm table-hover mb-0">
                                <tbody>
                                    ${sorted.map(([n, ct]) => `
                                        <tr>
                                            <td class="ps-3 text-truncate" style="max-width: 180px;" title="${n}">${n}</td>
                                            <td class="text-center fw-bold text-primary pe-3" style="width:40px">${ct}</td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${showExpandBtn ? `
                    <div class="card-footer p-0 bg-white border-top-0 text-center">
                        <button onclick="toggleExpand('${uniqueId}')" id="btn_${uniqueId}" class="btn btn-link btn-sm text-decoration-none shadow-none" style="font-size:0.7rem; width:100%;">
                            <i class="bi bi-chevron-down"></i> Ver todos (${totalItems})
                        </button>
                    </div>` : ''}
                </div>
            </div>`;
            
            cont.innerHTML += html;
        });
    }

    function toggleExpand(id) {
        const container = document.getElementById(`cont_${id}`);
        const btn = document.getElementById(`btn_${id}`);
    
        // Verificamos si tiene la clase "limit"
        if (container.classList.contains('table-container-limit')) {
            // EXPANDIR
            container.classList.remove('table-container-limit');
            container.classList.add('table-container-full');
            btn.innerHTML = '<i class="bi bi-chevron-up"></i> Ver menos';
        } else {
            // COLAPSAR
            container.classList.remove('table-container-full');
            container.classList.add('table-container-limit');
            // Recuperamos el número del texto original si quieres, o simplemente "Ver todos"
            btn.innerHTML = '<i class="bi bi-chevron-down"></i> Ver todos';
        }
    }

    function cambiarVista(v) {
        vista = v; 
        document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active-link'));
        const link = document.getElementById(`link-${v}`); if(link) link.classList.add('active-link');
        document.getElementById('viewTitle').innerText = (v === 'maquina') ? 'Inventario de Máquinas' : v;
        document.getElementById('panelFiltros').style.display = (v === 'maquina') ? 'block' : 'none';
        document.getElementById('tHeadSummary').style.display = 'none'; document.getElementById('tFoot').innerHTML = "";
        aplicarPermisosUI(); cancelarFormulario(); cerrarVistaDetalles(); cargarTabla();
    }

    async function abrirModalParametro(id = null) {
        editId = id; const container = document.getElementById('modalFields');
        let current = id ? await (await fetch(`${API}/${vista}/${id}`)).json() : {};
        let html = '';
        if (vista === 'usuario') {
            const isW = (current.usuario === 'willinthon');
            html = `<div class="mb-2"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div>
                    <div class="mb-2"><label class="filter-label">Usuario</label><input type="text" name="usuario" class="form-control" value="${current.usuario || ''}" required ${isW ? 'disabled' : ''}></div>
                    <div class="mb-2"><label class="filter-label">Clave</label><input type="password" name="clave" class="form-control" value="${current.clave || ''}" required></div>
                    <div class="mb-2"><label class="filter-label">Nivel</label><select name="nivel" class="form-select" ${isW ? 'disabled' : ''}><option value="1" ${current.nivel==1?'selected':''}>Admin</option><option value="2" ${current.nivel==2?'selected':''}>Supervisor</option><option value="3" ${current.nivel==3?'selected':''}>Normal</option></select></div>
                    ${isW ? '<input type="hidden" name="usuario" value="willinthon"><input type="hidden" name="nivel" value="1">' : ''}`;
        } else {
            const d = {'sucursal':[{l:'Grupo',t:'grupo',f:'grupo_id'}],'modelo':[{l:'Marca',t:'marca',f:'marca_id'}]};
            html = `<div class="mb-3"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div>`;
            if (d[vista]) { for (let x of d[vista]) { const o = await (await fetch(`${API}/options/${x.t}?userId=${usuarioActual.id}`)).json(); html += `<div class="mb-3"><label class="filter-label">${x.l}</label><select name="${x.f}" class="form-select" required><option value="">--</option>${o.map(opt => `<option value="${opt.id}" ${current[x.f] == opt.id ? 'selected' : ''}>${opt.nombre}</option>`).join('')}</select></div>`; } }
        }
        container.innerHTML = html; 
        if(vista === 'usuario') { activarValidacionEnInput('input[name="usuario"]', 'usuario', 'usuario', 'btnGuardarParam', id); }
        modalParam.show();
    }
    
    async function abrirEditorMaquina(id = null) {
        editId = id; 
        document.getElementById('section-lista').style.display = 'none'; 
        document.getElementById('section-formulario').style.display = 'block';
        const container = document.getElementById('camposMaquina');

        // Cambiamos {} por { puestos: 1 } para que las máquinas nuevas tengan valor inicial
        let current = id ? await (await fetch(`${API}/maquina/${id}`)).json() : { puestos: 1 };

        // 1. Iniciamos el HTML con los 3 campos de texto/número (Nombre, Serial, Puestos)
        // Usamos col-md-4 para que los tres queden en una sola fila arriba
        let html = `
            <div class="col-md-4 mb-2">
                <label class="filter-label">Nombre</label>
                <input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required>
            </div>
            <div class="col-md-4 mb-2">
                <label class="filter-label">Serial</label>
                <input type="text" name="serial" class="form-control" value="${current.serial || ''}" placeholder="Dejar vacío para N/A">
            </div>
            <div class="col-md-4 mb-2">
                <label class="filter-label">Puestos</label>
                <input type="number" id="inputPuestos" name="puestos" class="form-control" value="${current.puestos || 1}" min="1" required>
            </div>`;

        // 2. Mantenemos tu arreglo original de configuración para los selectores
        const dMaq = [
            { label: 'Sala / Grupo', table: 'sucursal', fk: 'sucursal_id', grouped: true }, 
            { label: 'Marca / Modelo', table: 'modelo', fk: 'modelo_id', grouped: true }, 
            { label: 'Juego', table: 'juego', fk: 'juego_id' }, 
            { label: 'Estado', table: 'estado', fk: 'estado_id' }, 
            { label: 'Sociedad', table: 'sociedad', fk: 'sociedad_id' }, 
            { label: 'Valor', table: 'valor', fk: 'valor_id' },
            { label: 'Tipo', table: 'tipo', fk: 'tipo_id' },
            { label: 'Modo', table: 'modo', fk: 'modo_id' },
            { label: 'Legal', table: 'legal', fk: 'legal_id' },
        ];

        // 3. Ejecutamos el ciclo para construir los selectores dinámicamente
        for (let d of dMaq) {
            const opts = await (await fetch(`${API}/options/${d.table}?userId=${usuarioActual.id}`)).json();
            html += `<div class="col-md-4 mb-2"><label class="filter-label">${d.label}</label><select name="${d.fk}" class="form-select" required><option value="">--</option>`;
            
            if (d.grouped) { 
                const g = {}; 
                opts.forEach(o => { 
                    const p = o.parent_nom || 'Otros'; 
                    if (!g[p]) g[p] = []; 
                    g[p].push(o); 
                }); 
                for (const p in g) { 
                    html += `<optgroup label="${p.toUpperCase()}">`; 
                    g[p].forEach(o => { 
                        html += `<option value="${o.id}" ${current[d.fk] == o.id ? 'selected' : ''}>${o.nombre}</option>`; 
                    }); 
                    html += `</optgroup>`; 
                }
            } else { 
                html += opts.map(o => `<option value="${o.id}" ${current[d.fk] == o.id ? 'selected' : ''}>${o.nombre}</option>`).join(''); 
            } 
            html += `</select></div>`;
        }

        // 4. Inyectamos todo el HTML generado en el contenedor
        container.innerHTML = html;

        // 5. LÓGICA DE VALIDACIÓN DINÁMICA
        const selectTipo = document.querySelector('select[name="tipo_id"]');
        const inputPuestos = document.getElementById('inputPuestos');

        if (selectTipo && inputPuestos) {
            // Función para aplicar la regla
            const aplicarReglaPuestos = () => {
                const textoTipo = selectTipo.options[selectTipo.selectedIndex].text.toUpperCase();
                
                if (textoTipo === "NORMAL") {
                    inputPuestos.value = 1;
                    inputPuestos.min = 1;
                    inputPuestos.readOnly = true; // Lo bloqueamos
                    inputPuestos.classList.add('bg-light'); // Color gris de deshabilitado
                } else if (textoTipo === "MULTIPUESTO") {
                    inputPuestos.readOnly = false;
                    inputPuestos.min = 2;
                    inputPuestos.classList.remove('bg-light');
                    // Si el valor actual es 1 y cambiaron a multipuesto, subimos a 2
                    if (parseInt(inputPuestos.value) < 2) {
                        inputPuestos.value = 2;
                    }
                } else {
                    // Para otros tipos que no sean ninguno de los dos
                    inputPuestos.readOnly = false;
                    inputPuestos.min = 1;
                    inputPuestos.classList.remove('bg-light');
                }
            };

            // Escuchar el cambio
            selectTipo.addEventListener('change', aplicarReglaPuestos);
            
            // Ejecutar una vez al abrir (por si es Edición)
            setTimeout(aplicarReglaPuestos, 500); // Pequeño delay para asegurar que los options cargaron
        }

        // 6. Activamos la validación de serial (recuerda aplicar la excepción para N/A que te pasé antes)
        activarValidacionEnInput('input[name="serial"]', 'maquina', 'serial', 'btnGuardarMaquina', id);
    }
    
    document.getElementById('formLogin').onsubmit = async (e) => { e.preventDefault(); try { const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ usuario: document.getElementById('log-user').value, clave: document.getElementById('log-pass').value }) }); const data = await res.json(); if (data.success) { localStorage.setItem('usuarioInventario', JSON.stringify(data.user)); verificarSesion(); } else { const err = document.getElementById('loginError'); err.innerText = data.message; err.style.display = 'block'; } } catch(e) { alert("Error de conexión"); } };
    document.getElementById('formParam').onsubmit = async (e) => { e.preventDefault(); await fetch(editId ? `${API}/${vista}/${editId}` : `${API}/${vista}`, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(e.target))) }); modalParam.hide(); cargarTabla(); };
    document.getElementById('formMaquinaFull').onsubmit = async (e) => { e.preventDefault(); await fetch(editId ? `${API}/maquina/${editId}` : `${API}/maquina`, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(e.target))) }); cancelarFormulario(); cargarTabla(); };

    function solicitarEliminar(id, tabla) { targetDelete = { id, tabla }; modalConfirm.show(); }
    document.getElementById('btnConfirmarAccion').onclick = async () => {
        const res = await fetch(`${API}/${targetDelete.tabla}/${targetDelete.id}`, { method: 'DELETE' });
        modalConfirm.hide();
        if (res.status === 409) { const data = await res.json(); document.getElementById('msgErrorRelacion').innerText = data.message; setTimeout(() => modalError.show(), 300); } else if (res.ok) { cargarTabla(); }
    };

    function cerrarSesion() { localStorage.removeItem('usuarioInventario'); usuarioActual = null; document.getElementById('view-app').style.display = 'none'; document.getElementById('view-login').style.display = 'flex'; }
    function cancelarFormulario() { document.getElementById('section-formulario').style.display = 'none'; document.getElementById('section-lista').style.display = 'block'; }
    function cerrarVistaDetalles() { document.getElementById('section-detalles').style.display = 'none'; document.getElementById('section-lista').style.display = 'block'; }
    function resetFiltros() { ['f-nombre','f-serial','f-grupo','f-sucursal','f-marca','f-modelo','f-juego','f-estado','f-sociedad','f-valor','f-tipo','f-modo','f-legal'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; }); cargarTabla(); }
    function controladorAccionNuevo() { if(vista === 'maquina') abrirEditorMaquina(); else abrirModalParametro(); }
    async function exportarExcel() {
        if (currentFiltered.length === 0) return alert("No hay datos para exportar");

        const workbook = new ExcelJS.Workbook();
        
        // --- FUNCIÓN HELPER ---
        const agregarHoja = async (nombreHoja, datos) => {
            const safeName = (nombreHoja || "Sin Sala").substring(0, 30).replace(/[\/\\\?\*\]\[]/g, '-');
            const worksheet = workbook.addWorksheet(safeName);

            // 1. Columnas
            worksheet.columns = [
                { header: 'NOMBRE', key: 'nombre' },
                { header: 'SERIAL', key: 'serial' },
                { header: 'MARCA', key: 'marca' },
                { header: 'MODELO', key: 'modelo' },
                { header: 'JUEGO', key: 'juego' },
                { header: 'TIPO', key: 'tipo' },
                { header: 'PUESTOS', key: 'puestos' },
                { header: 'MODO', key: 'modo' },
                { header: 'SOCIEDAD', key: 'sociedad' },
                { header: 'VALOR', key: 'valor' },
                { header: 'ESTADO', key: 'estado' },
                { header: 'LEGAL', key: 'legal' },
                { header: 'GRUPO', key: 'grupo' },
                { header: 'SALA', key: 'sala' }
            ];

            // 2. Datos
            datos.forEach(m => {
                worksheet.addRow({
                    nombre: (m.nombre || "").toUpperCase(),
                    serial: (m.serial || "N/A").toUpperCase(),
                    marca: (m.marca_nom || "").toUpperCase(),
                    modelo: (m.modelo_nom || "").toUpperCase(),
                    juego: (m.juego_nom || "").toUpperCase(),
                    tipo: (m.tipo_nom || "").toUpperCase(),
                    puestos: m.puestos || 1,
                    modo: (m.modo_nom || "").toUpperCase(),
                    sociedad: (m.sociedad_nom || "").toUpperCase(),
                    valor: (m.valor_nom || "").toUpperCase(),
                    estado: (m.estado_nom || "").toUpperCase(),
                    legal: (m.legal_nom || "NO").toUpperCase(),
                    grupo: (m.grupo_nom || "").toUpperCase(),
                    sala: (m.sala_nom || "").toUpperCase()
                });
            });

            // 3. ESTILO ENCABEZADO (Solo visual, sin función de filtro)
            const headerRow = worksheet.getRow(1);
            headerRow.height = 30; 
            
            headerRow.eachCell((cell) => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E78' } }; 
                cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 14, name: 'Calibri' };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                
                // Bloqueamos encabezados
                cell.protection = { locked: true }; 
            });

            // 4. ESTILO ZEBRA Y DESBLOQUEO DE DATOS
            worksheet.eachRow((row, rowNumber) => {
                if (rowNumber > 1) { 
                    row.eachCell({ includeEmpty: true }, (cell) => {
                        cell.border = { 
                            top: {style:'thin', color: {argb:'FFD9D9D9'}}, 
                            left: {style:'thin', color: {argb:'FFD9D9D9'}}, 
                            bottom: {style:'thin', color: {argb:'FFD9D9D9'}}, 
                            right: {style:'thin', color: {argb:'FFD9D9D9'}} 
                        };
                        if (rowNumber % 2 === 0) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEBF1DE' } };
                        }
                        // Desbloqueamos datos
                        cell.protection = { locked: false };
                    });
                }
            });

            // 5. AUTO-AJUSTE
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, function(cell) {
                    let cellLength = cell.value ? cell.value.toString().length : 0;
                    if (cell.row === 1) cellLength += 5; 
                    if (cellLength > maxLength) maxLength = cellLength;
                });
                column.width = maxLength < 12 ? 12 : maxLength + 2; 
            });

            // --- CAMBIO PRINCIPAL: ELIMINAMOS "worksheet.autoFilter" ---
            // Al borrar esa línea, las flechas desaparecen.

            // 6. PROTECCIÓN (Sin AutoFilter activado)
            await worksheet.protect('25047058', {
                selectLockedCells: true,   
                selectUnlockedCells: true, 
                formatColumns: true,       
                formatRows: true,
                // autoFilter: true,  <-- Como no pusimos el rango arriba, esto ya no hace falta activarlo
                sort: true                 
            });
        };

        // --- GENERACIÓN ---
        await agregarHoja("Todas las Salas", currentFiltered);

        const salasUnicas = [...new Set(currentFiltered.map(item => item.sala_nom || "Sin Asignar"))];
        for (const sala of salasUnicas) {
            const datosSala = currentFiltered.filter(item => (item.sala_nom || "Sin Asignar") === sala);
            if (datosSala.length > 0) {
                await agregarHoja(sala, datosSala);
            }
        }

        // --- DESCARGA ---
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        const hoy = new Date();
        const fechaStr = hoy.toLocaleDateString().replace(/\//g, '-');
        const horaStr = hoy.getHours() + "h" + hoy.getMinutes();
        anchor.download = `Inventario_Clean_${fechaStr}_${horaStr}.xlsx`;
        anchor.click();
        window.URL.revokeObjectURL(url);
    }

    function exportarPDF() {
    if (currentFiltered.length === 0) return alert("No hay datos para exportar");

    const { jsPDF } = window.jspdf;
    
    // 1. Crear documento en HORIZONTAL
    const doc = new jsPDF('landscape', 'mm', 'a4');

    // 2. Encabezado del Reporte
    const hoy = new Date();
    const fechaStr = hoy.toLocaleDateString();
    const horaStr = hoy.getHours() + ":" + hoy.getMinutes();
    
    // Título Principal
    doc.setFontSize(16);
    doc.setTextColor(31, 78, 120); // Azul corporativo
    doc.setFont("helvetica", "bold");
    doc.text("Reporte de Inventario de Máquinas", 10, 15); // Margen izquierdo reducido
    
    // Subtítulo con fecha
    doc.setFontSize(9);
    doc.setTextColor(100);
    doc.setFont("helvetica", "normal");
    doc.text(`Generado el: ${fechaStr} a las ${horaStr} | Registros: ${currentFiltered.length}`, 10, 20);

    // 3. Definir Columnas y Mapear Data
    const columns = [
        { header: 'NOMBRE', dataKey: 'nombre' },
        { header: 'SERIAL', dataKey: 'serial' },
        { header: 'MARCA', dataKey: 'marca' },
        { header: 'MODELO', dataKey: 'modelo' },
        { header: 'JUEGO', dataKey: 'juego' },
        { header: 'TIPO', dataKey: 'tipo' },
        { header: 'PUESTOS', dataKey: 'puestos' },
        { header: 'MODO', dataKey: 'modo' },
        { header: 'SOCIEDAD', dataKey: 'sociedad' }, 
        { header: 'VALOR', dataKey: 'valor' },
        { header: 'ESTADO', dataKey: 'estado' },
        { header: 'LEGAL', dataKey: 'legal' },
        { header: 'GRUPO', dataKey: 'grupo' },
        { header: 'SALA', dataKey: 'sala' }
    ];

    const rows = currentFiltered.map(m => ({
        nombre: (m.nombre || "").toUpperCase(),
        serial: (m.serial || "N/A").toUpperCase(),
        marca: (m.marca_nom || "").toUpperCase(),
        modelo: (m.modelo_nom || "").toUpperCase(),
        juego: (m.juego_nom || "").toUpperCase(),
        tipo: (m.tipo_nom || "").toUpperCase(),
        puestos: m.puestos || 1,
        modo: (m.modo_nom || "").toUpperCase(),
        sociedad: (m.sociedad_nom || "").toUpperCase(),
        valor: (m.valor_nom || "").toUpperCase(),
        estado: (m.estado_nom || "").toUpperCase(),
        legal: (m.legal_nom || "NO").toUpperCase(),
        grupo: (m.grupo_nom || "").toUpperCase(),
        sala: (m.sala_nom || "").toUpperCase()
    }));

    // 4. GENERAR TABLA AUTO-AJUSTABLE
    doc.autoTable({
        columns: columns,
        body: rows,
        startY: 25,
        
        // --- MÁRGENES ESTRECHOS (Para aprovechar la hoja) ---
        margin: { top: 25, left: 5, right: 5, bottom: 10 },

        // --- ESTILOS GENERALES (Compactos) ---
        theme: 'grid',
        styles: {
            fontSize: 6.5,       // <--- Letra pequeña para que quepa todo
            cellPadding: 1.5,    // <--- Menos relleno para ahorrar espacio
            valign: 'middle',
            overflow: 'linebreak', // <--- Importante: Texto largo salta de línea
            lineWidth: 0.1,      // Líneas finas
            lineColor: [200, 200, 200]
        },

        // --- ESTILO ENCABEZADO ---
        headStyles: { 
            fillColor: [31, 78, 120], 
            textColor: 255, 
            fontSize: 7,         // Título un pelín más grande que el texto
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle'
        },

        // --- ESTILO FILAS (Cebra) ---
        alternateRowStyles: { 
            fillColor: [240, 245, 235] // Un verde/gris muy pálido para leer mejor
        },

        // --- ANCHOS DE COLUMNA PERSONALIZADOS ---
        // Aquí distribuimos los 287mm disponibles (297mm hoja - 10mm márgenes)
        columnStyles: {
            nombre:    { cellWidth: 'auto', fontStyle: 'bold' }, // El más importante
            serial:    { cellWidth: 'auto' },
            marca:     { cellWidth: 'auto' },
            modelo:    { cellWidth: 'auto' },
            juego:     { cellWidth: 'auto' }, // Juegos suelen tener nombres largos
            tipo:      { cellWidth: 'auto' },
            puestos:   { cellWidth: 'auto' }, // Muy pequeño
            modo:      { cellWidth: 'auto' },
            sociedad:  { cellWidth: 'auto' },
            valor:     { cellWidth: 'auto' },
            estado:    { cellWidth: 'auto' },
            legal:     { cellWidth: 'auto' },
            grupo:     { cellWidth: 'auto' },
            sala:      { cellWidth: 'auto' } // El resto del espacio para la sala
        }
    });

    // 5. Guardar
    const nombreArchivo = `Inventario_Maquinas_${fechaStr.replace(/\//g, '-')}.pdf`;
    doc.save(nombreArchivo);
}
    document.querySelectorAll('.form-filter').forEach(el => el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'keyup', aplicarFiltros));
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW fail', err));
      });
    }

    verificarSesion();
</script>
</body>
</html>