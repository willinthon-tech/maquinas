<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Wisi</title>
    
    <link rel="icon" type="image/png" href="/logo_wisi.png">
    <link rel="apple-touch-icon" href="/logo_wisi.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #1a1a27;
            --bg-body: #f4f7f6;
            --accent: #009ef7;
            --sidebar-width: 240px;
        }

        body { background: var(--bg-body); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; overflow: hidden; }

        /* LOGIN RESPONSIVO */
        #view-login { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-dark); padding: 20px; }
        .login-card { width: 100%; max-width: 380px; border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }

        /* ESTRUCTURA PRINCIPAL */
        #view-app { display: none; height: 100vh; width: 100%; flex-direction: row; }

        /* SIDEBAR */
        #sidebar { 
            width: var(--sidebar-width); background: var(--bg-dark); padding: 20px 15px; 
            flex-shrink: 0; display: flex; flex-direction: column; transition: transform 0.3s ease; 
            z-index: 1050;
        }
        #sidebar .brand { color: white; text-align: center; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid #2b2b40; padding-bottom: 20px; margin-bottom: 20px; font-size: 1rem; letter-spacing: 1px; }
        #sidebar a { color: #92929f; display: block; padding: 12px 15px; text-decoration: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; margin-bottom: 4px; }
        #sidebar a:hover, .active-link { background: #2b2b40; color: var(--accent) !important; font-weight: 600; }
        
        .sidebar-user-info { padding: 15px; text-align: center; border-top: 1px solid #2b2b40; margin-top: auto; background: #1e1e2d; border-radius: 12px; cursor: pointer; }
        .user-name { color: white; font-size: 0.9rem; font-weight: 600; display: block; }
        .user-level { color: var(--accent); font-size: 0.75rem; text-transform: uppercase; font-weight: 800; display: block; margin-bottom: 8px; }
        .btn-logout { color: #f1416c !important; border: 1px solid #f1416c; font-size: 0.8rem; font-weight: bold; padding: 8px; }

        /* CONTENIDO PRINCIPAL */
        #main { flex-grow: 1; padding: 25px; overflow-y: auto; width: 100%; }
        
        /* TABLAS CON SCROLL MOVIL */
        .table-wrap { 
            background: white; border-radius: 12px; overflow-x: auto; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e1e3ea;
        }
        .table { font-size: 0.8rem; vertical-align: middle; margin-bottom: 0; min-width: 850px; }
        .table thead th { background: #f8f9fa; color: #5e6278; font-weight: 700; text-transform: uppercase; font-size: 0.7rem; padding: 15px 10px; border-bottom: 2px solid #f1f1f4; }
        .table tbody td { padding: 12px 10px; border-bottom: 1px solid #f1f1f4; }

        /* HEADER PARA MOVILES */
        #mobile-nav { 
            display: none; background: var(--bg-dark); color: white; padding: 12px 20px; 
            align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1040;
        }

        /* FILTROS RESPONSIVOS */
        .filter-label { font-size: 0.65rem; font-weight: 800; color: #7e8299; text-transform: uppercase; margin-bottom: 5px; }
        .form-filter { font-size: 0.85rem; height: 42px; border: 1px solid #dbdfe9; background-color: #ffffff; }

        /* DISEÑO DE DETALLES (CARDS) */
        .detail-card { border: none; border-radius: 12px; background: white; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); overflow: hidden; }
        .detail-card h6 { font-size: 0.75rem; font-weight: 800; background: #f1f1f4; padding: 12px; margin: 0; color: #181c32; text-transform: uppercase; border-bottom: 1px solid #e1e3ea; }

        /* VALIDACIONES */
        .is-invalid { border-color: #f1416c !important; }
        .feedback-error { color: #f1416c; font-size: 0.7rem; margin-top: 4px; font-weight: 600; display: none; }

        /* MEDIA QUERIES */
        @media (max-width: 992px) {
            #view-app { flex-direction: column; }
            #mobile-nav { display: flex; }
            #sidebar { 
                position: fixed; left: 0; transform: translateX(-100%); 
                top: 56px; bottom: 0; width: 280px; 
            }
            #sidebar.show { transform: translateX(0); }
            #main { padding: 15px; height: calc(100vh - 56px); }
            .col-md-3, .col-md-6, .col-md-4 { width: 50%; }
            .btn-nuevo-global { width: 100%; margin-top: 5px; }
        }

        @media (max-width: 576px) {
            .col-md-3, .col-md-6 { width: 100%; }
            .user-name { font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div id="mobile-nav">
    <div onclick="toggleSidebar()" style="cursor: pointer; font-size: 1.2rem;">☰</div>
    <div class="fw-bold" style="letter-spacing: 1px;">WISI INVENTARIO</div>
    <div style="width: 24px;"></div> </div>

<div id="view-login">
    <div class="card login-card p-4">
        <div class="text-center mb-4">
            <img src="/logo_wisi.png" alt="Logo" style="width: 70px; margin-bottom: 15px;">
            <h4 class="fw-bold text-dark">BIENVENIDO</h4>
            <p class="text-muted small">Ingrese sus credenciales para continuar</p>
        </div>
        <form id="formLogin">
            <div class="mb-3">
                <label class="filter-label">Usuario</label>
                <input type="text" id="log-user" class="form-control form-filter shadow-none" required>
            </div>
            <div class="mb-4">
                <label class="filter-label">Clave</label>
                <input type="password" id="log-pass" class="form-control form-filter shadow-none" required>
            </div>
            <div id="loginError" class="alert alert-danger p-2 small mb-3" style="display:none;"></div>
            <button type="submit" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">INICIAR SESIÓN</button>
        </form>
    </div>
</div>

<div id="view-app">
    <nav id="sidebar">
        <div class="brand">Inventario Global<br>de Maquinas</div>
        <a onclick="menuNav('maquina')" id="link-maquina">Máquinas</a>
        <div id="menu-admin-only">
            <hr style="border-color: #2b2b40; opacity: 0.5;">
            <a onclick="menuNav('grupo')" id="link-grupo">Grupos</a>
            <a onclick="menuNav('sucursal')" id="link-sucursal">Sucursales</a>
            <a onclick="menuNav('estado')" id="link-estado">Estados</a>
            <a onclick="menuNav('sociedad')" id="link-sociedad">Sociedades</a>
            <a onclick="menuNav('valor')" id="link-valor">Valores</a>
            <a onclick="menuNav('juego')" id="link-juego">Juegos</a>
            <a onclick="menuNav('marca')" id="link-marca">Marcas</a>
            <a onclick="menuNav('modelo')" id="link-modelo">Modelos</a>
        </div>
        <div class="sidebar-user-info" onclick="irAVistaUsuarios(); if(window.innerWidth < 992) toggleSidebar();">
            <span class="user-name" id="display-user-name">---</span>
            <span class="user-level" id="display-user-level">---</span>
            <button onclick="event.stopPropagation(); cerrarSesion();" class="btn btn-logout w-100 mt-2">CERRAR SESIÓN</button>
        </div>
    </nav>

    <main id="main">
        <div id="section-lista">
            <div class="row align-items-center mb-4 g-2">
                <div class="col-12 col-lg-8">
                    <h4 id="viewTitle" class="fw-bold m-0 text-dark">Inventario de Máquinas</h4>
                </div>
                <div class="col-12 col-lg-4 text-lg-end">
                    <button class="btn btn-success btn-action px-4 py-2 w-100" id="btn-nuevo-global" onclick="controladorAccionNuevo()">+ Nuevo Registro</button>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4" id="panelFiltros" style="display:none;">
                <div class="card-body p-3">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="filter-label">Nombre de Máquina</label><input type="text" id="f-nombre" class="form-control form-filter shadow-none" placeholder="Ej: Ruleta 01"></div>
                        <div class="col-md-6"><label class="filter-label">Número de Serial</label><input type="text" id="f-serial" class="form-control form-filter shadow-none" placeholder="Ej: SN-456"></div>
                        <div class="col-md-3 col-6"><label class="filter-label">Grupo</label><select id="f-grupo" class="form-select form-filter shadow-none"></select></div>
                        <div class="col-md-3 col-6"><label class="filter-label">Sala</label><select id="f-sucursal" class="form-select form-filter shadow-none"></select></div>
                        <div class="col-md-3 col-6"><label class="filter-label">Marca</label><select id="f-marca" class="form-select form-filter shadow-none"></select></div>
                        <div class="col-md-3 col-6"><label class="filter-label">Modelo</label><select id="f-modelo" class="form-select form-filter shadow-none"></select></div>
                        
                        <div class="col-12 d-flex flex-wrap gap-2 mt-2">
                            <button class="btn btn-light btn-sm flex-fill" onclick="resetFiltros()">Limpiar Filtros</button>
                            <button class="btn btn-warning btn-sm flex-fill fw-bold text-dark" onclick="exportarExcel()">Descargar Excel</button>
                            <button class="btn btn-primary btn-sm flex-fill fw-bold" onclick="window.print()">Imprimir</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-wrap">
                <table class="table table-hover">
                    <thead id="tHead">
                        <tr id="tHeadSummary" class="report-summary-row" style="display:none;"><td colspan="12"></td></tr>
                        <tr id="tHeadTitles" class="table-light"></tr>
                    </thead>
                    <tbody id="tBody"></tbody>
                    <tfoot id="tFoot"></tfoot>
                </table>
            </div>
        </div>

        <div id="section-detalles" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0">Análisis Estadístico</h5>
                <button class="btn btn-dark btn-sm px-4" onclick="cerrarVistaDetalles()">← Volver al Listado</button>
            </div>
            <div class="alert alert-info border-0 shadow-sm py-3 mb-4" id="alertFiltrosDetalles"></div>
            <div class="row g-3" id="containerTablasDetalles"></div>
        </div>

        <div id="section-formulario" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0">Editor de Registros</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="cancelarFormulario()">Cancelar y Volver</button>
            </div>
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <form id="formMaquinaFull">
                        <div class="row g-3" id="camposMaquina"></div>
                        <div class="mt-4 pt-4 border-top text-end">
                            <button type="submit" id="btnGuardarMaquina" class="btn btn-primary px-5 py-2 fw-bold">Guardar Información</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalSucursales" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h6 class="modal-title fw-bold">Gestionar Permisos de Sucursal</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted x-small mb-3">Seleccione las sucursales a las que este usuario podrá acceder:</p>
                <div id="containerSucursales" class="border rounded" style="max-height: 300px; overflow-y: auto; background: #fafafa;"></div>
            </div>
            <div class="modal-footer border-0">
                <button onclick="guardarSucursales()" class="btn btn-primary w-100 fw-bold">Actualizar Permisos</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarEliminar" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-4">
                <div class="text-danger mb-3" style="font-size: 2rem;">⚠</div>
                <h6 class="fw-bold">¿Desea eliminar el registro?</h6>
                <p class="text-muted small">Esta acción no se puede deshacer.</p>
                <div class="d-flex gap-2 mt-4">
                    <button type="button" class="btn btn-light flex-fill" data-bs-dismiss="modal">No, cancelar</button>
                    <button type="button" class="btn btn-danger flex-fill fw-bold" id="btnConfirmarAccion">Sí, eliminar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalErrorRelacion" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0 text-danger"><h6 class="modal-title fw-bold">Acción Denegada</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <p class="small text-muted" id="msgErrorRelacion"></p>
                <button type="button" class="btn btn-dark btn-sm w-100 mt-2" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "/api"; 
    let vista = "maquina", allData = [], editId = null, currentFiltered = [], usuarioActual = null, refreshInt = null;
    let targetDelete = { id: null, tabla: null };
    let tempUserId = null; 

    const modalParam = new bootstrap.Modal(document.getElementById('modalParam'));
    const modalConfirm = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
    const modalError = new bootstrap.Modal(document.getElementById('modalErrorRelacion'));
    const modalSucursales = new bootstrap.Modal(document.getElementById('modalSucursales'));

    // --- FUNCIONES DE INTERFAZ ---
    function toggleSidebar() {
        if (window.innerWidth <= 992) {
            document.getElementById('sidebar').classList.toggle('show');
        }
    }

    function menuNav(v) {
        cambiarVista(v);
        if (window.innerWidth <= 992) toggleSidebar();
    }

    function aplicarPermisosUI() {
        if(!usuarioActual) return;
        document.getElementById('menu-admin-only').style.display = (usuarioActual.nivel == 1) ? 'block' : 'none';
        document.getElementById('btn-nuevo-global').style.display = (usuarioActual.nivel == 3) ? 'none' : 'block';
    }

    function verificarSesion() {
        const stored = localStorage.getItem('usuarioInventario');
        if (stored) {
            usuarioActual = JSON.parse(stored);
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-app').style.display = 'flex';
            actualizarInterfazPerfil();
            cambiarVista('maquina');
            iniciarRealTime();
        } else {
            detenerRealTime();
            document.getElementById('view-login').style.display = 'flex';
            document.getElementById('view-app').style.display = 'none';
        }
    }

    function actualizarInterfazPerfil() {
        const lvls = {1:'Administrador', 2:'Supervisor', 3:'Normal'};
        document.getElementById('display-user-name').innerText = usuarioActual.nombre;
        document.getElementById('display-user-level').innerText = lvls[usuarioActual.nivel] || 'Usuario';
    }

    function irAVistaUsuarios() { if(usuarioActual.nivel == 1) cambiarVista('usuario'); }

    function iniciarRealTime() {
        if(refreshInt) clearInterval(refreshInt);
        refreshInt = setInterval(async () => {
            if(!document.querySelector('.modal.show') && document.getElementById('section-formulario').style.display === 'none') {
                await cargarTabla();
                sincronizarUsuarioLogueado();
                if(document.getElementById('section-detalles').style.display === 'block') abrirVistaDetalles(true);
            }
        }, 5000);
    }

    async function sincronizarUsuarioLogueado() {
        try {
            const res = await fetch(`${API}/usuario/${usuarioActual.id}`);
            const data = await res.json();
            if(data.id) { usuarioActual = data; localStorage.setItem('usuarioInventario', JSON.stringify(data)); actualizarInterfazPerfil(); }
        } catch(e) {}
    }

    function detenerRealTime() { if(refreshInt) clearInterval(refreshInt); }

    async function cargarTabla() {
        const res = await fetch(`${API}/${vista}?userId=${usuarioActual.id}`);
        const data = await res.json();
        allData = Array.isArray(data) ? data : [];
        if (vista === 'maquina') aplicarFiltros(); else renderizarTabla(allData);
    }

    function aplicarFiltros() {
        if (vista !== 'maquina') return;
        const rawNombre = document.getElementById('f-nombre')?.value || "";
        const rawSerial = document.getElementById('f-serial')?.value || "";
        const fNombre = rawNombre.toLowerCase();
        const fSerial = rawSerial.toLowerCase();
        const getS = (id) => document.getElementById(id)?.value || "";
        const f = {
            Grupo: getS('f-grupo'), Sala: getS('f-sucursal'), Marca: getS('f-marca'),
            Modelo: getS('f-modelo'), Juego: getS('f-juego'), Estado: getS('f-estado'),
            Sociedad: getS('f-sociedad'), Valor: getS('f-valor')
        };
        currentFiltered = allData.filter(m => 
            (m.nombre.toLowerCase().includes(fNombre)) && 
            (m.serial.toLowerCase().includes(fSerial)) &&
            (f.Grupo === "" || m.grupo_nom === f.Grupo) &&
            (f.Sala === "" || m.sala_nom === f.Sala) &&
            (f.Marca === "" || m.marca_nom === f.Marca) &&
            (f.Modelo === "" || m.modelo_nom === f.Modelo) &&
            (f.Juego === "" || m.juego_nom === f.Juego) &&
            (f.Estado === "" || m.estado_nom === f.Estado) &&
            (f.Sociedad === "" || m.sociedad_nom === f.Sociedad) &&
            (f.Valor === "" || m.valor_nom === f.Valor)
        );
        renderizarTabla(currentFiltered);
        actualizarDropdownsDinamicos(currentFiltered);
        generarResumenReporte(currentFiltered.length, { Nombre: rawNombre, Serial: rawSerial, ...f });
    }

    function renderizarTabla(data) {
        const titles = document.getElementById('tHeadTitles'), body = document.getElementById('tBody');
        const styleAcc = (usuarioActual.nivel == 3) ? 'display:none' : '';
        if(vista === 'maquina') {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>Serial</th><th>Grupo</th><th>Sala</th><th>Marca</th><th>Modelo</th><th>Juego</th><th>Estado</th><th>Soc.</th><th>Val.</th><th class="text-center" style="${styleAcc}">Acciones</th>`;
            body.innerHTML = data.map(i => `<tr><td>${i.id}</td><td><b>${i.nombre}</b></td><td><span class="badge bg-dark">${i.serial}</span></td><td>${i.grupo_nom || '-'}</td><td>${i.sala_nom || '-'}</td><td>${i.marca_nom || '-'}</td><td>${i.modelo_nom || '-'}</td><td>${i.juego_nom || '-'}</td><td>${i.estado_nom || '-'}</td><td>${i.sociedad_nom || '-'}</td><td>${i.valor_nom || '-'}</td><td class="text-center" style="${styleAcc}"><button onclick="abrirEditorMaquina(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> <button onclick="solicitarEliminar(${i.id}, 'maquina')" class="btn btn-outline-danger btn-action ms-1">Borrar</button></td></tr>`).join('');
        } else if (vista === 'sucursal' || vista === 'modelo') {
            const padre = (vista === 'sucursal') ? 'Grupo' : 'Marca';
            const nomPadre = (vista === 'sucursal') ? 'grupo_nom' : 'marca_nom';
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>${padre}</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => `<tr><td>${i.id}</td><td>${i.nombre}</td><td><span class="badge bg-light text-dark border">${i[nomPadre] || '-'}</span></td><td class="text-center"><button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> <button onclick="solicitarEliminar(${i.id}, '${vista}')" class="btn btn-outline-danger btn-action ms-1">Borrar</button></td></tr>`).join('');
        } else if (vista === 'usuario') {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th>Usuario</th><th>Nivel</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => { 
                const l = {1:'Admin', 2:'Supervisor', 3:'Normal'}; 
                return `<tr>
                    <td>${i.id}</td>
                    <td>${i.nombre}</td>
                    <td>${i.usuario}</td>
                    <td><span class="badge bg-info text-dark">${l[i.nivel]}</span></td>
                    <td class="text-center">
                        <button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button>
                        <button onclick="abrirModalSucursales(${i.id})" class="btn btn-outline-warning btn-action ms-1">Sucursales</button>
                        ${(i.usuario === 'willinthon') ? '<button class="btn btn-outline-secondary btn-action ms-1" disabled>Lock</button>' : `<button onclick="solicitarEliminar(${i.id}, 'usuario')" class="btn btn-outline-danger btn-action ms-1">Borrar</button>`}
                    </td>
                </tr>`; 
            }).join('');
        } else {
            titles.innerHTML = `<th>ID</th><th>Nombre</th><th class="text-center">Acciones</th>`;
            body.innerHTML = data.map(i => `<tr><td>${i.id}</td><td>${i.nombre}</td><td class="text-center"><button onclick="abrirModalParametro(${i.id})" class="btn btn-outline-primary btn-action">Editar</button> <button onclick="solicitarEliminar(${i.id}, '${vista}')" class="btn btn-outline-danger btn-action ms-1">Borrar</button></td></tr>`).join('');
        }
    }

    function activarValidacionEnInput(selectorInput, tabla, campo, btnGuardarId, idRegistro = null) {
        const input = document.querySelector(selectorInput);
        if (!input) return;
        if(input.parentNode.querySelector('.feedback-error')){ input.parentNode.querySelector('.feedback-error').remove(); }
        let errorMsg = document.createElement('div');
        errorMsg.className = 'feedback-error';
        errorMsg.innerText = `Este ${campo} ya existe en la base de datos.`;
        input.parentNode.appendChild(errorMsg);
        const btn = document.getElementById(btnGuardarId);
        input.classList.remove('is-invalid');
        errorMsg.style.display = 'none';
        if(btn) btn.disabled = false;
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        const activeInput = document.querySelector(selectorInput);
        if(!activeInput.parentNode.querySelector('.feedback-error')) { activeInput.parentNode.appendChild(errorMsg); }
        activeInput.addEventListener('keyup', async () => {
            const valor = activeInput.value.trim();
            if (valor.length < 2) {
                 activeInput.classList.remove('is-invalid');
                 errorMsg.style.display = 'none';
                 if(btn) btn.disabled = false;
                 return; 
            }
            try {
                let url = `${API}/validar/${tabla}/${campo}/${valor}`;
                if(idRegistro) { url += `?excludeId=${idRegistro}`; }
                const res = await fetch(url);
                const data = await res.json();
                if (data.existe) {
                    activeInput.classList.add('is-invalid');
                    errorMsg.style.display = 'block';
                    if(btn) btn.disabled = true;
                } else {
                    activeInput.classList.remove('is-invalid');
                    errorMsg.style.display = 'none';
                    if(btn) btn.disabled = false;
                }
            } catch (e) { console.error(e); }
        });
    }

    async function abrirModalSucursales(userId) {
        tempUserId = userId;
        const container = document.getElementById('containerSucursales');
        container.innerHTML = `<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><span class="ms-2 small text-muted">Cargando lista completa...</span></div>`;
        modalSucursales.show();
        try {
            const resAll = await fetch(`${API}/options/sucursal`);
            const resPerm = await fetch(`${API}/permisos_sucursal/${userId}`);
            if (!resAll.ok || !resPerm.ok) throw new Error("Error al obtener datos");
            const allSuc = await resAll.json();
            const userPerms = await resPerm.json();
            if(allSuc.length === 0){ container.innerHTML = '<p class="text-muted text-center small p-3">No hay sucursales registradas.</p>'; return; }
            let html = '';
            allSuc.forEach(s => {
                const isChecked = userPerms.includes(s.id) ? 'checked' : '';
                const grupoLabel = s.parent_nom ? `<span class="badge bg-secondary" style="font-size:0.6rem">${s.parent_nom}</span> ` : '';
                html += `
                    <div class="form-check border-bottom py-2 px-4 m-0">
                        <input class="form-check-input chk-sucursal" type="checkbox" value="${s.id}" id="chk_${s.id}" ${isChecked}>
                        <label class="form-check-label small w-100" for="chk_${s.id}" style="cursor:pointer">
                            ${grupoLabel} <b>${s.nombre}</b>
                        </label>
                    </div>`;
            });
            container.innerHTML = html;
        } catch(e) { container.innerHTML = '<p class="text-danger small text-center p-3">Error de conexión al cargar sucursales.</p>'; }
    }

    async function guardarSucursales() {
        const btn = document.querySelector('#modalSucursales .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "Guardando...";
        btn.disabled = true;
        try {
            const checkedBoxes = document.querySelectorAll('.chk-sucursal:checked');
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
            const res = await fetch(`${API}/asignar_sucursales`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usuario_id: tempUserId, sucursales: selectedIds })
            });
            if(res.ok) { modalSucursales.hide(); } else { alert("Error al guardar."); }
        } catch(e) { alert("Error de conexión."); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

    function actualizarDropdownsDinamicos(data) {
        const conf = {'f-grupo':'grupo_nom','f-sucursal':'sala_nom','f-marca':'marca_nom','f-modelo':'modelo_nom','f-juego':'juego_nom','f-estado':'estado_nom','f-sociedad':'sociedad_nom','f-valor':'valor_nom'};
        Object.keys(conf).forEach(id => { 
            const s = document.getElementById(id); 
            if(!s || document.activeElement === s) return; 
            const v = s.value; 
            const u = [...new Set(data.map(i => i[conf[id]]))].filter(x => x).sort(); 
            s.innerHTML = '<option value="">TODOS</option>' + u.map(x => `<option value="${x}" ${x==v?'selected':''}>${x}</option>`).join(''); 
        });
    }

    function generarResumenReporte(total, filtros) {
        if (vista !== 'maquina') return;
        let aplicados = []; 
        for (const [k, v] of Object.entries(filtros)) { if (v !== "") aplicados.push(`${k}: ${v}`); }
        let txt = `Total: ( <b>${total}</b> )`; if (aplicados.length > 0) txt += `, Filtros: ( ${aplicados.length} )`;
        const content = `<div class="d-flex align-items-center justify-content-between w-100"><div>${txt}</div><div><button class="btn btn-dark btn-action" onclick="abrirVistaDetalles()">Análisis</button></div></div>`;
        document.getElementById('tFoot').innerHTML = `<tr><td colspan="12">${content}</td></tr>`;
        document.getElementById('tHeadSummary').style.display = 'table-row'; document.getElementById('tHeadSummary').cells[0].innerHTML = content;
        document.getElementById('alertFiltrosDetalles').innerHTML = txt;
    }
    
    function abrirVistaDetalles(isRefresh = false) {
        if(!isRefresh) { document.getElementById('section-lista').style.display = 'none'; document.getElementById('section-detalles').style.display = 'block'; }
        const cont = document.getElementById('containerTablasDetalles'); cont.innerHTML = "";
        const cats = [{ label: 'Grupos', key: 'grupo_nom' }, { label: 'Salas', key: 'sala_nom' }, { label: 'Marcas', key: 'marca_nom' }, { label: 'Modelos', key: 'modelo_nom' }, { label: 'Juegos', key: 'juego_nom' }, { label: 'Estados', key: 'estado_nom' }, { label: 'Sociedades', key: 'sociedad_nom' }, { label: 'Valores', key: 'valor_nom' }];
        cats.forEach(c => {
            const count = {}; currentFiltered.forEach(m => { let l = (c.key === 'modelo_nom') ? `${m.modelo_nom || 'N/A'} (${m.marca_nom || 'N/A'})` : (c.key === 'sala_nom') ? `${m.sala_nom || 'N/A'} (${m.grupo_nom || 'N/A'})` : m[c.key] || 'N/A'; count[l] = (count[l] || 0) + 1; });
            const sorted = Object.entries(count).sort((a,b) => b[1] - a[1]);
            cont.innerHTML += `<div class="col-md-3"><div class="card detail-card shadow-sm"><h6>${c.label}</h6><table class="table detail-table table-sm table-hover mb-0" style="min-width:100%"><tbody>${sorted.map(([n, ct]) => `<tr><td>${n}</td><td class="text-center fw-bold text-primary" style="width:40px">${ct}</td></tr>`).join('')}</tbody></table></div></div>`;
        });
    }

    function cambiarVista(v) {
        vista = v; 
        document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active-link'));
        const link = document.getElementById(`link-${v}`); if(link) link.classList.add('active-link');
        document.getElementById('viewTitle').innerText = (v === 'maquina') ? 'Inventario de Máquinas' : v;
        document.getElementById('panelFiltros').style.display = (v === 'maquina') ? 'block' : 'none';
        document.getElementById('tHeadSummary').style.display = 'none'; document.getElementById('tFoot').innerHTML = "";
        aplicarPermisosUI(); cancelarFormulario(); cerrarVistaDetalles(); cargarTabla();
    }

    async function abrirModalParametro(id = null) {
        editId = id; const container = document.getElementById('modalFields');
        let current = id ? await (await fetch(`${API}/${vista}/${id}`)).json() : {};
        let html = '';
        if (vista === 'usuario') {
            const isW = (current.usuario === 'willinthon');
            html = `<div class="mb-2"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div>
                    <div class="mb-2"><label class="filter-label">Usuario</label><input type="text" name="usuario" class="form-control" value="${current.usuario || ''}" required ${isW ? 'disabled' : ''}></div>
                    <div class="mb-2"><label class="filter-label">Clave</label><input type="password" name="clave" class="form-control" value="${current.clave || ''}" required></div>
                    <div class="mb-2"><label class="filter-label">Nivel</label><select name="nivel" class="form-select" ${isW ? 'disabled' : ''}><option value="1" ${current.nivel==1?'selected':''}>Admin</option><option value="2" ${current.nivel==2?'selected':''}>Supervisor</option><option value="3" ${current.nivel==3?'selected':''}>Normal</option></select></div>
                    ${isW ? '<input type="hidden" name="usuario" value="willinthon"><input type="hidden" name="nivel" value="1">' : ''}`;
        } else {
            const d = {'sucursal':[{l:'Grupo',t:'grupo',f:'grupo_id'}],'modelo':[{l:'Marca',t:'marca',f:'marca_id'}]};
            html = `<div class="mb-3"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div>`;
            if (d[vista]) { for (let x of d[vista]) { const o = await (await fetch(`${API}/options/${x.t}?userId=${usuarioActual.id}`)).json(); html += `<div class="mb-3"><label class="filter-label">${x.l}</label><select name="${x.f}" class="form-select" required><option value="">--</option>${o.map(opt => `<option value="${opt.id}" ${current[x.f] == opt.id ? 'selected' : ''}>${opt.nombre}</option>`).join('')}</select></div>`; } }
        }
        container.innerHTML = html; 
        if(vista === 'usuario') { activarValidacionEnInput('input[name="usuario"]', 'usuario', 'usuario', 'btnGuardarParam', id); }
        modalParam.show();
    }
    
    async function abrirEditorMaquina(id = null) {
        editId = id; document.getElementById('section-lista').style.display = 'none'; document.getElementById('section-formulario').style.display = 'block';
        const container = document.getElementById('camposMaquina');
        let current = id ? await (await fetch(`${API}/maquina/${id}`)).json() : {};
        let html = `<div class="col-md-6 mb-2"><label class="filter-label">Nombre</label><input type="text" name="nombre" class="form-control" value="${current.nombre || ''}" required></div><div class="col-md-6 mb-2"><label class="filter-label">Serial</label><input type="text" name="serial" class="form-control" value="${current.serial || ''}" required></div>`;
        const dMaq = [{ label: 'Sala / Grupo', table: 'sucursal', fk: 'sucursal_id', grouped: true }, { label: 'Marca / Modelo', table: 'modelo', fk: 'modelo_id', grouped: true }, { label: 'Juego', table: 'juego', fk: 'juego_id' }, { label: 'Estado', table: 'estado', fk: 'estado_id' }, { label: 'Sociedad', table: 'sociedad', fk: 'sociedad_id' }, { label: 'Valor', table: 'valor', fk: 'valor_id' }];
        for (let d of dMaq) {
            const opts = await (await fetch(`${API}/options/${d.table}?userId=${usuarioActual.id}`)).json();
            html += `<div class="col-md-4 mb-2"><label class="filter-label">${d.label}</label><select name="${d.fk}" class="form-select" required><option value="">--</option>`;
            if (d.grouped) { const g = {}; opts.forEach(o => { const p = o.parent_nom || 'Otros'; if (!g[p]) g[p] = []; g[p].push(o); }); for (const p in g) { html += `<optgroup label="${p.toUpperCase()}">`; g[p].forEach(o => { html += `<option value="${o.id}" ${current[d.fk] == o.id ? 'selected' : ''}>${o.nombre}</option>`; }); html += `</optgroup>`; }
            } else { html += opts.map(o => `<option value="${o.id}" ${current[d.fk] == o.id ? 'selected' : ''}>${o.nombre}</option>`).join(''); } html += `</select></div>`;
        }
        container.innerHTML = html;
        activarValidacionEnInput('input[name="serial"]', 'maquina', 'serial', 'btnGuardarMaquina', id);
    }
    
    document.getElementById('formLogin').onsubmit = async (e) => { e.preventDefault(); try { const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ usuario: document.getElementById('log-user').value, clave: document.getElementById('log-pass').value }) }); const data = await res.json(); if (data.success) { localStorage.setItem('usuarioInventario', JSON.stringify(data.user)); verificarSesion(); } else { const err = document.getElementById('loginError'); err.innerText = data.message; err.style.display = 'block'; } } catch(e) { alert("Error de conexión"); } };
    document.getElementById('formParam').onsubmit = async (e) => { e.preventDefault(); await fetch(editId ? `${API}/${vista}/${editId}` : `${API}/${vista}`, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(e.target))) }); modalParam.hide(); cargarTabla(); };
    document.getElementById('formMaquinaFull').onsubmit = async (e) => { e.preventDefault(); await fetch(editId ? `${API}/maquina/${editId}` : `${API}/maquina`, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(e.target))) }); cancelarFormulario(); cargarTabla(); };

    function solicitarEliminar(id, tabla) { targetDelete = { id, tabla }; modalConfirm.show(); }
    document.getElementById('btnConfirmarAccion').onclick = async () => {
        const res = await fetch(`${API}/${targetDelete.tabla}/${targetDelete.id}`, { method: 'DELETE' });
        modalConfirm.hide();
        if (res.status === 409) { const data = await res.json(); document.getElementById('msgErrorRelacion').innerText = data.message; setTimeout(() => modalError.show(), 300); } else if (res.ok) { cargarTabla(); }
    };

    function cerrarSesion() { localStorage.removeItem('usuarioInventario'); usuarioActual = null; document.getElementById('view-app').style.display = 'none'; document.getElementById('view-login').style.display = 'flex'; }
    function cancelarFormulario() { document.getElementById('section-formulario').style.display = 'none'; document.getElementById('section-lista').style.display = 'block'; }
    function cerrarVistaDetalles() { document.getElementById('section-detalles').style.display = 'none'; document.getElementById('section-lista').style.display = 'block'; }
    function resetFiltros() { ['f-nombre','f-serial','f-grupo','f-sucursal','f-marca','f-modelo','f-juego','f-estado','f-sociedad','f-valor'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; }); cargarTabla(); }
    function controladorAccionNuevo() { if(vista === 'maquina') abrirEditorMaquina(); else abrirModalParametro(); }
    function exportarExcel() { const ws = XLSX.utils.json_to_sheet(currentFiltered.map(m => ({ "Nombre": m.nombre, "Serial": m.serial, "Grupo": m.grupo_nom, "Sala": m.sala_nom, "Marca": m.marca_nom, "Modelo": m.modelo_nom, "Juego": m.juego_nom, "Estado": m.estado_nom, "Sociedad": m.sociedad_nom, "Valor": m.valor_nom }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Inventario"); XLSX.writeFile(wb, "Inventario.xlsx"); }
    
    document.querySelectorAll('.form-filter').forEach(el => el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'keyup', aplicarFiltros));
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW fail', err));
      });
    }

    verificarSesion();
</script>
</body>
</html>